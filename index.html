<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อรายวิชา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        * {
            font-family: 'Kanit', sans-serif;
        }
        
        .gradient-bg-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-bg-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .gradient-bg-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .gradient-bg-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .gradient-bg-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .gradient-bg-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        
        .status-present { background-color: #10b981; }
        .status-late { background-color: #f59e0b; }
        .status-sick { background-color: #f97316; }
        .status-business { background-color: #3b82f6; }
        .status-permission { background-color: #8b5cf6; }
        .status-absent { background-color: #6b7280; }
        
        .row-present { background-color: #ecfdf5; }
        .row-late { background-color: #fffbeb; }
        .row-sick { background-color: #fff7ed; }
        .row-business { background-color: #eff6ff; }
        .row-permission { background-color: #f3e8ff; }
        .row-absent { background-color: #f9fafb; }
        
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .progress-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            min-width: 300px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 4px;
            transition: width 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-2xl text-orange-500 mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">ระบบเช็คชื่อรายวิชา</h1>
                </div>
                
                <!-- Guest Navigation (when not logged in) -->
                <div id="guestNav" class="flex items-center space-x-3">
                    <button id="navLoginBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-yellow-600 transition-all duration-200 font-medium">
                        <i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบ
                    </button>
                    <button id="navRegisterBtn" class="border border-orange-500 text-orange-500 px-4 py-2 rounded-lg hover:bg-orange-50 transition-all duration-200 font-medium">
                        <i class="fas fa-user-plus mr-2"></i>สมัครสมาชิก
                    </button>
                </div>
                
                <!-- User Navigation (when logged in) -->
                <div id="userNav" class="hidden flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <!-- User Profile Dropdown -->
                        <div class="relative">
                            <button id="userProfileBtn" class="flex items-center bg-gray-50 hover:bg-gray-100 rounded-lg px-3 py-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-yellow-500 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-white text-sm"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-xs text-gray-500">เข้าสู่ระบบด้วย</div>
                                    <div id="userEmail" class="text-sm font-medium text-gray-900"></div>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 ml-2 text-xs"></i>
                            </button>
                            
                            <!-- Dropdown Menu -->
                            <div id="userDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-200 z-50 overflow-hidden">
                                <!-- User Info Header -->
                                <div class="bg-gradient-to-r from-orange-500 to-yellow-500 px-4 py-3">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        <div>
                                            <div id="userDisplayName" class="text-white font-semibold text-sm">ผู้ใช้งาน</div>
                                            <div id="userEmailDropdown" class="text-orange-100 text-xs"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Menu Items -->
                                <div class="py-2">
                                    <button id="editProfileBtn" class="w-full flex items-center px-4 py-3 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors duration-200">
                                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-user-edit text-blue-600 text-sm"></i>
                                        </div>
                                        <div class="text-left">
                                            <div class="font-medium text-sm">แก้ไขข้อมูลส่วนตัว</div>
                                            <div class="text-xs text-gray-500">เปลี่ยนชื่อและข้อมูลผู้ใช้</div>
                                        </div>
                                    </button>
                                    
                                    <button id="changePasswordBtn" class="w-full flex items-center px-4 py-3 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors duration-200">
                                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-key text-purple-600 text-sm"></i>
                                        </div>
                                        <div class="text-left">
                                            <div class="font-medium text-sm">เปลี่ยนรหัสผ่าน</div>
                                            <div class="text-xs text-gray-500">อัปเดตรหัสผ่านของคุณ</div>
                                        </div>
                                    </button>
                                    
                                    <div class="border-t border-gray-100 my-2"></div>
                                    
                                    <button id="logoutBtn" class="w-full flex items-center px-4 py-3 text-red-600 hover:bg-red-50 transition-colors duration-200">
                                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-sign-out-alt text-red-600 text-sm"></i>
                                        </div>
                                        <div class="text-left">
                                            <div class="font-medium text-sm">ออกจากระบบ</div>
                                            <div class="text-xs text-red-400">ออกจากบัญชีผู้ใช้</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1">
        <!-- Login Page -->
        <div id="loginPage" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-white relative">
            <div class="w-full sm:w-96 max-w-md space-y-8">
                <!-- Background decoration -->
                <div class="absolute inset-0 bg-gradient-to-br from-gray-700/20 via-gray-500/20 to-gray-300/20"></div>
                
                <!-- Main card -->
                <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-white/20 p-8 relative overflow-hidden">
                    <!-- Decorative elements -->
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-orange-400/20 to-yellow-500/20 rounded-full -translate-y-16 translate-x-16"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-purple-500/20 to-pink-500/20 rounded-full translate-y-12 -translate-x-12"></div>
                    
                    <!-- Header -->
                    <div class="text-center mb-8 relative z-10">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-2xl mb-6 shadow-lg">
                            <i class="fas fa-graduation-cap text-3xl text-white"></i>
                        </div>
                        <h2 class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-yellow-600 bg-clip-text text-transparent">
                            ระบบเช็คชื่อรายวิชา
                        </h2>
                        <p class="text-gray-600 mt-2">เข้าสู่ระบบเพื่อจัดการการเรียนการสอน</p>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="mb-8 relative z-10">
                        <div class="flex bg-gray-100 rounded-2xl p-1 relative">
                            <div id="tabIndicator" class="absolute top-1 left-1 w-1/2 h-10 bg-white rounded-xl shadow-md transition-transform duration-300 ease-out"></div>
                            <button id="teacherTab" class="flex-1 py-2.5 px-4 text-center text-sm font-semibold text-orange-600 relative z-10 rounded-xl transition-colors duration-200">
                                <i class="fas fa-chalkboard-teacher mr-2"></i>ครู
                            </button>
                            <button id="studentTab" class="flex-1 py-2.5 px-4 text-center text-sm font-semibold text-gray-500 relative z-10 rounded-xl transition-colors duration-200">
                                <i class="fas fa-user-graduate mr-2"></i>นักเรียน
                            </button>
                        </div>
                    </div>

                    <!-- Teacher Login -->
                    <div id="teacherLogin" class="relative z-10">
                        <form id="teacherLoginForm" class="space-y-6">
                            <div class="space-y-4">
                                <div class="relative">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">อีเมล</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-envelope text-gray-400"></i>
                                        </div>
                                        <input type="email" id="teacherEmail" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white" placeholder="กรอกอีเมลของคุณ" required>
                                    </div>
                                </div>
                                <div class="relative">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">รหัสผ่าน</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-lock text-gray-400"></i>
                                        </div>
                                        <input type="password" id="teacherPassword" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white" placeholder="กรอกรหัสผ่าน" required>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-yellow-500 text-white py-3 px-6 rounded-xl font-semibold hover:from-orange-600 hover:to-yellow-600 transform hover:scale-[1.02] transition-all duration-200 shadow-lg hover:shadow-xl">
                                <i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบ
                            </button>
                        </form>
                        
                        <!-- Forgot Password Link -->
                        <div class="text-center mt-4">
                            <button id="forgotPasswordBtn" class="text-purple-600 hover:text-purple-700 font-medium text-sm transition-colors duration-200 flex items-center justify-center mx-auto">
                                <i class="fas fa-key mr-2"></i>ลืมรหัสผ่าน?
                            </button>
                        </div>
                        
                        <!-- Register Link -->
                        <div class="text-center mt-6 pt-6 border-t border-gray-200">
                            <p class="text-gray-600 text-sm mb-3">ยังไม่มีบัญชี?</p>
                            <button id="showRegisterBtn" class="text-pink-600 hover:text-pink-700 font-semibold text-sm transition-colors duration-200 flex items-center justify-center mx-auto">
                                <i class="fas fa-user-plus mr-2"></i>สมัครสมาชิกใหม่
                            </button>
                        </div>
                    </div>

                    <!-- Teacher Registration -->
                    <div id="teacherRegister" class="hidden relative z-10">
                        <form id="teacherRegisterForm" class="space-y-6">
                            <div class="space-y-4">
                                <div class="relative">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-user text-gray-400"></i>
                                        </div>
                                        <input type="text" id="teacherFullName" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white" placeholder="เช่น อาจารย์สมชาย ใจดี" required>
                                    </div>
                                </div>
                                <div class="relative">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">อีเมล</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-envelope text-gray-400"></i>
                                        </div>
                                        <input type="email" id="registerEmail" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white" placeholder="กรอกอีเมลของคุณ" required>
                                    </div>
                                </div>
                                <div class="relative">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">รหัสผ่าน</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-lock text-gray-400"></i>
                                        </div>
                                        <input type="password" id="registerPassword" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white" placeholder="อย่างน้อย 6 ตัวอักษร" minlength="6" required>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2 flex items-center">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร
                                    </p>
                                </div>
                                <div class="relative">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ยืนยันรหัสผ่าน</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-lock text-gray-400"></i>
                                        </div>
                                        <input type="password" id="confirmPassword" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white" placeholder="กรอกรหัสผ่านอีกครั้ง" minlength="6" required>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white py-3 px-6 rounded-xl font-semibold hover:from-pink-600 hover:to-purple-600 transform hover:scale-[1.02] transition-all duration-200 shadow-lg hover:shadow-xl">
                                <i class="fas fa-user-plus mr-2"></i>สมัครสมาชิก
                            </button>
                        </form>
                        
                        <!-- Back to Login Link -->
                        <div class="text-center mt-6 pt-6 border-t border-gray-200">
                            <p class="text-gray-600 text-sm mb-3">มีบัญชีแล้ว?</p>
                            <button id="showLoginBtn" class="text-orange-600 hover:text-orange-700 font-semibold text-sm transition-colors duration-200 flex items-center justify-center mx-auto">
                                <i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบ
                            </button>
                        </div>
                    </div>

                    <!-- Student Portal -->
                    <div id="studentLogin" class="hidden relative z-10">
                        <div class="space-y-6">
                            <div class="text-center mb-6">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-green-500 to-teal-500 rounded-2xl mb-4 shadow-lg">
                                    <i class="fas fa-search text-2xl text-white"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">ค้นหาประวัติการเข้าเรียน</h3>
                                <p class="text-gray-600 text-sm mt-1">กรอกรหัสนักเรียนเพื่อดูประวัติการเรียน</p>
                            </div>
                            <div class="relative">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">รหัสนักเรียน</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-id-card text-gray-400"></i>
                                    </div>
                                    <input type="text" id="studentId" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white text-center text-lg font-mono tracking-wider" placeholder="กรอกรหัสนักเรียน">
                                </div>
                            </div>
                            <button id="viewAttendanceBtn" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-green-700 hover:to-teal-700 transform hover:scale-[1.02] transition-all duration-200 shadow-lg hover:shadow-xl">
                                <i class="fas fa-search mr-2"></i>ค้นหาประวัติการเข้าเรียน
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Footer info -->
                <div class="text-center text-sm text-gray-500 mt-8">
                    <p class="flex items-center justify-center">
                        <i class="fas fa-shield-alt mr-2 text-green-500"></i>
                        ระบบปลอดภัย เข้ารหัสข้อมูล SSL
                    </p>
                </div>
              <!-- ซ่อนไว้ก็ได้ แล้วค่อยเปิดเฉพาะแอดมิน -->
              <div style="display:flex; gap:.5rem; margin:.5rem 0;">
                <button id="btn-change-config">ตั้งค่า/แก้ไข Firebase</button>
                <button id="btn-view-config">ดูคอนฟิก</button>
                <button id="btn-reset-config">ลบคอนฟิก (เครื่องนี้)</button>
              </div>

            </div>
        </div>

        <!-- Class List Page -->
        <div id="classListPage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900">รายวิชาของฉัน</h2>
                <div class="flex space-x-3">
                    <button id="showArchivedBtn" class="bg-gradient-to-r from-gray-600 to-gray-700 text-white px-6 py-3 rounded-xl hover:from-gray-700 hover:to-gray-800 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center">
                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-archive text-sm"></i>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-semibold">ห้องเรียนที่จัดเก็บ</div>
                            <div class="text-xs text-gray-200">ดูห้องเรียนที่เก็บไว้</div>
                        </div>
                    </button>
                    <button id="createClassBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center">
                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-plus text-sm"></i>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-semibold">สร้างห้องเรียนใหม่</div>
                            <div class="text-xs text-blue-200">เพิ่มห้องเรียนใหม่</div>
                        </div>
                    </button>
                </div>
            </div>
            
            <div id="classList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Class cards will be populated here -->
            </div>
        </div>

        <!-- Create Class Modal -->
        <div id="createClassModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 overflow-hidden border border-blue-100">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 px-8 py-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4 backdrop-blur-sm">
                            <i class="fas fa-plus-circle text-2xl text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">สร้างห้องเรียนใหม่</h3>
                            <p class="text-blue-100 text-sm mt-1">เพิ่มห้องเรียนและรายชื่อนักเรียนเข้าสู่ระบบ</p>
                        </div>
                    </div>
                </div>

                <div class="p-8">
                    <form id="createClassForm" class="space-y-6">
                        <!-- Course Name Section -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center mr-3">
                                    <i class="fas fa-book text-white"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-blue-800">ข้อมูลห้องเรียน</h4>
                                    <p class="text-blue-600 text-sm">กรอกชื่อวิชาและห้องเรียน</p>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-semibold text-blue-800">ชื่อวิชา-ห้อง <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-chalkboard-teacher text-blue-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="className" class="w-full pl-10 pr-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800 font-medium" placeholder="เช่น คณิตศาสตร์ ม.1/1, ภาษาไทย ป.6/2" required>
                                </div>
                                <p class="text-xs text-blue-600 flex items-center">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ระบุชื่อวิชาและระดับชั้นให้ชัดเจน
                                </p>
                            </div>
                        </div>

                        <!-- Student List Section -->
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border border-green-200">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center mr-3">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-green-800">รายชื่อนักเรียน</h4>
                                    <p class="text-green-600 text-sm">นำเข้ารายชื่อนักเรียน (ไม่บังคับ)</p>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-semibold text-green-800">รายชื่อนักเรียน (คั่นด้วย Tab)</label>
                                <div class="relative">
                                    <textarea id="studentList" class="w-full px-4 py-3 border-2 border-green-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800 h-32 font-mono text-sm" placeholder="1	65001	นาย	สมชาย	ใจดี&#10;2	65002	นางสาว	สมหญิง	รักเรียน&#10;3	65003	เด็กชาย	สมศักดิ์	เรียนดี"></textarea>
                                </div>
                                <div class="bg-white rounded-lg p-3 border border-green-200">
                                    <div class="text-xs text-green-700 space-y-1">
                                        <div class="font-semibold flex items-center">
                                            <i class="fas fa-clipboard-list mr-2"></i>
                                            รูปแบบการนำเข้า:
                                        </div>
                                        <div class="font-mono bg-green-100 px-2 py-1 rounded">เลขที่[Tab]รหัสนักเรียน[Tab]คำนำหน้า[Tab]ชื่อ[Tab]สกุล</div>
                                        <div class="text-green-600">
                                            • สามารถเว้นว่างไว้และเพิ่มนักเรียนทีหลังได้<br>
                                            • คัดลอกจาก Excel โดยเลือกทั้ง 5 คอลัมน์แล้ววาง<br>
                                            • คำนำหน้า: นาย, นางสาว, เด็กชาย, เด็กหญิง
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex space-x-4 pt-6 border-t border-gray-200">
                            <button type="button" id="cancelCreateClass" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-xl hover:bg-gray-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-times mr-2"></i>ยกเลิก
                            </button>
                            <button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-3 px-6 rounded-xl hover:from-blue-600 hover:to-indigo-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-plus-circle mr-2"></i>สร้างห้องเรียน
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Manage Students Modal -->
        <div id="manageStudentsModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full mx-4 max-h-[95vh] overflow-hidden border border-orange-100">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-orange-500 to-yellow-500 px-8 py-6">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4 backdrop-blur-sm">
                                <i class="fas fa-users-cog text-2xl text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-white">จัดการข้อมูลนักเรียน</h3>
                                <p class="text-orange-100 text-sm mt-1">เพิ่ม แก้ไข และจัดการรายชื่อนักเรียนในห้องเรียน</p>
                            </div>
                        </div>
                        <button id="closeManageStudents" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl p-3 transition-all duration-200 backdrop-blur-sm">
                            <i class="fas fa-times text-xl text-white"></i>
                        </button>
                    </div>
                </div>

                <div class="p-8 overflow-y-auto max-h-[calc(95vh-120px)]">
                    <!-- Add Student Form -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 mb-8 border border-gray-300 shadow-sm">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gradient-to-r from-gray-500 to-gray-600 rounded-xl flex items-center justify-center mr-3">
                                    <i class="fas fa-user-plus text-white"></i>
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-gray-800">เพิ่มนักเรียนใหม่</h4>
                                    <p class="text-gray-600 text-sm">กรอกข้อมูลนักเรียนที่ต้องการเพิ่มเข้าห้องเรียน</p>
                                </div>
                            </div>
                        </div>
                        
                        <form id="addStudentForm" class="space-y-6">
                            <div class="flex items-end gap-4">
                                <div class="flex-1 grid grid-cols-1 md:grid-cols-5 gap-4">
                                    <div class="space-y-2">
                                        <label class="block text-sm font-semibold text-gray-700">เลขที่</label>
                                        <div class="relative">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <i class="fas fa-hashtag text-gray-400 text-sm"></i>
                                            </div>
                                            <input type="text" id="newStudentNumber" class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" placeholder="1">
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <label class="block text-sm font-semibold text-gray-700">รหัสนักเรียน <span class="text-red-500">*</span></label>
                                        <div class="relative">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <i class="fas fa-id-card text-gray-400 text-sm"></i>
                                            </div>
                                            <input type="text" id="newStudentId" class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" placeholder="65001" required>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <label class="block text-sm font-semibold text-gray-700">คำนำหน้า</label>
                                        <div class="relative">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <i class="fas fa-user-tag text-gray-400 text-sm"></i>
                                            </div>
                                            <select id="newStudentPrefix" class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800 appearance-none">
                                                <option value="นาย">นาย</option>
                                                <option value="นางสาว">นางสาว</option>
                                                <option value="เด็กชาย">เด็กชาย</option>
                                                <option value="เด็กหญิง">เด็กหญิง</option>
                                            </select>
                                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <label class="block text-sm font-semibold text-gray-700">ชื่อ <span class="text-red-500">*</span></label>
                                        <div class="relative">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <i class="fas fa-user text-gray-400 text-sm"></i>
                                            </div>
                                            <input type="text" id="newStudentFirstName" class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" placeholder="สมชาย" required>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <label class="block text-sm font-semibold text-gray-700">สกุล <span class="text-red-500">*</span></label>
                                        <div class="relative">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <i class="fas fa-user text-gray-400 text-sm"></i>
                                            </div>
                                            <input type="text" id="newStudentLastName" class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" placeholder="ใจดี" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex-shrink-0">
                                    <button type="submit" class="bg-gradient-to-r from-gray-600 to-gray-700 text-white px-8 py-3 rounded-xl hover:from-gray-700 hover:to-gray-800 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center h-[52px]">
                                        <i class="fas fa-plus mr-3"></i>เพิ่มนักเรียน
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Students List -->
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-orange-100">
                        <div class="bg-gradient-to-r from-orange-500 to-yellow-500 px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-list text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-white">รายชื่อนักเรียนทั้งหมด</h4>
                                        <p class="text-orange-100 text-sm">จัดการข้อมูลนักเรียนในห้องเรียน</p>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 rounded-lg px-3 py-1 backdrop-blur-sm">
                                    <span id="studentCount" class="text-white font-semibold text-sm">0 คน</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto max-h-96">
                            <table class="min-w-full">
                                <thead class="bg-gradient-to-r from-orange-50 to-yellow-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-sm font-bold text-orange-800 uppercase tracking-wider border-r border-orange-200">
                                            <div class="flex items-center">
                                                <i class="fas fa-hashtag mr-2 text-orange-600"></i>
                                                เลขที่
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-bold text-orange-800 uppercase tracking-wider border-r border-orange-200">
                                            <div class="flex items-center">
                                                <i class="fas fa-id-card mr-2 text-orange-600"></i>
                                                รหัสนักเรียน
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-bold text-orange-800 uppercase tracking-wider border-r border-orange-200">
                                            <div class="flex items-center">
                                                <i class="fas fa-user mr-2 text-orange-600"></i>
                                                ชื่อ-สกุล
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-center text-sm font-bold text-orange-800 uppercase tracking-wider">
                                            <div class="flex items-center justify-center">
                                                <i class="fas fa-cogs mr-2 text-orange-600"></i>
                                                จัดการ
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="manageStudentsTableBody" class="bg-white divide-y divide-orange-100">
                                    <!-- Students will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200">
                        <div class="text-sm text-gray-600 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            <span>การเปลี่ยนแปลงจะมีผลหลังจากกดปุ่ม "บันทึกการเปลี่ยนแปลง"</span>
                        </div>
                        <div class="flex space-x-3">
                            <button id="cancelStudentChanges" class="bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center">
                                <i class="fas fa-times mr-2"></i>ยกเลิก
                            </button>
                            <button id="saveStudentChanges" class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-8 py-3 rounded-xl hover:from-blue-600 hover:to-indigo-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center">
                                <i class="fas fa-save mr-3"></i>บันทึกการเปลี่ยนแปลง
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden border border-blue-100">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 px-8 py-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4 backdrop-blur-sm">
                            <i class="fas fa-user-edit text-2xl text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">แก้ไขข้อมูลส่วนตัว</h3>
                            <p class="text-blue-100 text-sm mt-1">อัปเดตข้อมูลผู้ใช้งานของคุณ</p>
                        </div>
                    </div>
                </div>

                <div class="p-8">
                    <form id="editProfileForm" class="space-y-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-blue-800">ชื่อ-นามสกุล <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-user text-blue-400 text-sm"></i>
                                </div>
                                <input type="text" id="editDisplayName" class="w-full pl-10 pr-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" placeholder="กรอกชื่อ-นามสกุล" required>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-blue-800">อีเมล</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-envelope text-blue-400 text-sm"></i>
                                </div>
                                <input type="email" id="editEmail" class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed" disabled>
                            </div>
                            <p class="text-xs text-gray-500 flex items-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                อีเมลไม่สามารถเปลี่ยนแปลงได้
                            </p>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex space-x-4 pt-6 border-t border-gray-200">
                            <button type="button" id="cancelEditProfile" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-xl hover:bg-gray-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-times mr-2"></i>ยกเลิก
                            </button>
                            <button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-3 px-6 rounded-xl hover:from-blue-600 hover:to-indigo-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-save mr-2"></i>บันทึกการแก้ไข
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden border border-purple-100">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 px-8 py-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4 backdrop-blur-sm">
                            <i class="fas fa-key text-2xl text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">เปลี่ยนรหัสผ่าน</h3>
                            <p class="text-purple-100 text-sm mt-1">อัปเดตรหัสผ่านเพื่อความปลอดภัย</p>
                        </div>
                    </div>
                </div>

                <div class="p-8">
                    <form id="changePasswordForm" class="space-y-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-purple-800">รหัสผ่านปัจจุบัน <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-lock text-purple-400 text-sm"></i>
                                </div>
                                <input type="password" id="currentPassword" class="w-full pl-10 pr-4 py-3 border-2 border-purple-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" placeholder="กรอกรหัสผ่านปัจจุบัน" required>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-purple-800">รหัสผ่านใหม่ <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-key text-purple-400 text-sm"></i>
                                </div>
                                <input type="password" id="newPassword" class="w-full pl-10 pr-4 py-3 border-2 border-purple-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" placeholder="กรอกรหัสผ่านใหม่" minlength="6" required>
                            </div>
                            <p class="text-xs text-purple-600 flex items-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร
                            </p>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-purple-800">ยืนยันรหัสผ่านใหม่ <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-check-circle text-purple-400 text-sm"></i>
                                </div>
                                <input type="password" id="confirmNewPassword" class="w-full pl-10 pr-4 py-3 border-2 border-purple-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" placeholder="กรอกรหัสผ่านใหม่อีกครั้ง" minlength="6" required>
                            </div>
                        </div>
                        
                        <!-- Security Tips -->
                        <div class="bg-purple-50 rounded-xl p-4 border border-purple-200">
                            <div class="flex items-center mb-2">
                                <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center mr-2">
                                    <i class="fas fa-shield-alt text-white text-xs"></i>
                                </div>
                                <span class="font-semibold text-purple-800 text-sm">คำแนะนำความปลอดภัย</span>
                            </div>
                            <ul class="text-xs text-purple-700 space-y-1 list-disc list-inside">
                                <li>ใช้รหัสผ่านที่มีความยาวอย่างน้อย 8 ตัวอักษร</li>
                                <li>ผสมผสานตัวอักษรใหญ่ เล็ก ตัวเลข และสัญลักษณ์</li>
                                <li>หลีกเลี่ยงการใช้ข้อมูลส่วนตัวที่เดาได้ง่าย</li>
                            </ul>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex space-x-4 pt-6 border-t border-gray-200">
                            <button type="button" id="cancelChangePassword" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-xl hover:bg-gray-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-times mr-2"></i>ยกเลิก
                            </button>
                            <button type="submit" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-6 rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-key mr-2"></i>เปลี่ยนรหัสผ่าน
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Student Modal -->
        <div id="editStudentModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden border border-blue-100">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 px-8 py-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4 backdrop-blur-sm">
                            <i class="fas fa-user-edit text-2xl text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">แก้ไขข้อมูลนักเรียน</h3>
                            <p class="text-blue-100 text-sm mt-1">ปรับปรุงข้อมูลนักเรียนให้ถูกต้อง</p>
                        </div>
                    </div>
                </div>

                <div class="p-8">
                    <form id="editStudentForm" class="space-y-6">
                        <input type="hidden" id="editStudentOriginalId">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-semibold text-blue-800">เลขที่</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-hashtag text-blue-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="editStudentNumber" class="w-full pl-10 pr-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800">
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-semibold text-blue-800">รหัสนักเรียน <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-id-card text-blue-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="editStudentId" class="w-full pl-10 pr-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-blue-800">คำนำหน้า</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-user-tag text-blue-400 text-sm"></i>
                                </div>
                                <select id="editStudentPrefix" class="w-full pl-10 pr-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800 appearance-none">
                                    <option value="นาย">นาย</option>
                                    <option value="นางสาว">นางสาว</option>
                                    <option value="เด็กชาย">เด็กชาย</option>
                                    <option value="เด็กหญิง">เด็กหญิง</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <i class="fas fa-chevron-down text-blue-400 text-sm"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-semibold text-blue-800">ชื่อ <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-user text-blue-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="editStudentFirstName" class="w-full pl-10 pr-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" required>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-semibold text-blue-800">สกุล <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-user text-blue-400 text-sm"></i>
                                    </div>
                                    <input type="text" id="editStudentLastName" class="w-full pl-10 pr-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex space-x-4 pt-6 border-t border-gray-200">
                            <button type="button" id="cancelEditStudent" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-xl hover:bg-gray-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-times mr-2"></i>ยกเลิก
                            </button>
                            <button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-3 px-6 rounded-xl hover:from-blue-600 hover:to-indigo-600 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-save mr-2"></i>บันทึกการแก้ไข
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Archived Classes Modal -->
        <div id="archivedClassesModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full mx-4 max-h-[95vh] overflow-hidden border border-gray-100">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-gray-600 to-slate-700 px-8 py-6">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4 backdrop-blur-sm">
                                <i class="fas fa-archive text-2xl text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-white">ห้องเรียนที่จัดเก็บ</h3>
                                <p class="text-gray-200 text-sm mt-1">จัดการห้องเรียนที่ถูกจัดเก็บไว้</p>
                            </div>
                        </div>
                        <button id="closeArchivedClasses" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl p-3 transition-all duration-200 backdrop-blur-sm">
                            <i class="fas fa-times text-xl text-white"></i>
                        </button>
                    </div>
                </div>

                <div class="p-8 overflow-y-auto max-h-[calc(95vh-120px)]">
                    <!-- Info Card -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-8 border border-blue-200">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center mr-3">
                                <i class="fas fa-info-circle text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-blue-800">เกี่ยวกับห้องเรียนที่จัดเก็บ</h4>
                                <p class="text-blue-600 text-sm">ข้อมูลและการจัดการห้องเรียนที่ถูกจัดเก็บ</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white rounded-lg p-4 border border-blue-200">
                                <div class="flex items-center mb-2">
                                    <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-2">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                    <span class="font-semibold text-green-800 text-sm">ข้อมูลที่เก็บไว้</span>
                                </div>
                                <ul class="text-xs text-green-700 space-y-1 list-disc list-inside ml-4">
                                    <li>รายชื่อนักเรียนทั้งหมด</li>
                                    <li>ประวัติการเช็คชื่อ</li>
                                    <li>สถิติการเรียน</li>
                                </ul>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 border border-blue-200">
                                <div class="flex items-center mb-2">
                                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center mr-2">
                                        <i class="fas fa-cogs text-white text-xs"></i>
                                    </div>
                                    <span class="font-semibold text-blue-800 text-sm">การจัดการ</span>
                                </div>
                                <ul class="text-xs text-blue-700 space-y-1 list-disc list-inside ml-4">
                                    <li>กู้คืนห้องเรียน</li>
                                    <li>ลบถาวร</li>
                                    <li>ดูข้อมูลสรุป</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Archived Classes List -->
                    <div id="archivedClassesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Archived classes will be populated here -->
                    </div>

                    <!-- No Archived Classes -->
                    <div class="text-center mt-8" id="noArchivedClasses" style="display: none;">
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-12 border border-gray-200">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-gray-400 to-gray-500 rounded-full mb-6 shadow-lg">
                                <i class="fas fa-archive text-3xl text-white"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-600 mb-3">ไม่มีห้องเรียนที่จัดเก็บ</h3>
                            <p class="text-gray-500 mb-6">ยังไม่มีห้องเรียนที่ถูกจัดเก็บในระบบ</p>
                            <div class="bg-white rounded-xl p-4 border border-gray-200 max-w-md mx-auto">
                                <div class="text-sm text-gray-600 space-y-2">
                                    <div class="flex items-center">
                                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                        <span class="font-medium">เคล็ดลับ:</span>
                                    </div>
                                    <p class="text-left">คุณสามารถจัดเก็บห้องเรียนได้โดยคลิกปุ่ม <i class="fas fa-archive text-gray-400"></i> ที่มุมบนขวาของการ์ดห้องเรียน</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Page -->
        <div id="attendancePage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Simple Header -->
            <div class="mb-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-4 sm:mb-0">
                        <button id="backToClassList" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all duration-200 mb-4">
                            <i class="fas fa-arrow-left mr-2"></i>กลับไปรายวิชา
                        </button>
                        <div class="flex items-center">
                            <h2 id="currentClassName" class="text-3xl font-bold text-gray-900 mr-3"></h2>
                            <button id="editClassNameBtn" class="bg-blue-500 hover:bg-blue-600 text-white rounded-lg p-2 transition-all duration-200">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <p class="text-lg text-gray-600 mt-1">ระบบเช็คชื่อรายวิชา</p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <input type="date" id="attendanceDate" class="border border-gray-300 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                        <button id="manageStudentsBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl transition-all duration-200 flex items-center justify-center font-medium">
                            <i class="fas fa-users-cog mr-2"></i>จัดการนักเรียน
                        </button>
                        <button id="summaryBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl transition-all duration-200 flex items-center justify-center font-medium">
                            <i class="fas fa-chart-bar mr-2"></i>สรุปผลการเรียน
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Card -->
            <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-2xl shadow-lg p-6 mb-8 border border-orange-200">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-yellow-500 rounded-xl flex items-center justify-center mr-3">
                        <i class="fas fa-tasks text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-orange-800">การดำเนินการแบบกลุ่ม</h3>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    <button class="bulk-btn bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-3 rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 text-sm font-medium shadow-md hover:shadow-lg transform hover:scale-105" data-status="present">
                        <i class="fas fa-check mb-1 block"></i>เช็คทั้งหมด
                    </button>
                    <button class="bulk-btn bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-4 py-3 rounded-xl hover:from-yellow-600 hover:to-yellow-700 transition-all duration-200 text-sm font-medium shadow-md hover:shadow-lg transform hover:scale-105" data-status="late">
                        <i class="fas fa-clock mb-1 block"></i>มาสายทั้งหมด
                    </button>
                    <button class="bulk-btn bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-3 rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all duration-200 text-sm font-medium shadow-md hover:shadow-lg transform hover:scale-105" data-status="sick">
                        <i class="fas fa-thermometer-half mb-1 block"></i>ลาป่วยทั้งหมด
                    </button>
                    <button class="bulk-btn bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-3 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-200 text-sm font-medium shadow-md hover:shadow-lg transform hover:scale-105" data-status="business">
                        <i class="fas fa-briefcase mb-1 block"></i>ลากิจทั้งหมด
                    </button>
                    <button class="bulk-btn bg-gradient-to-r from-purple-500 to-purple-600 text-white px-4 py-3 rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all duration-200 text-sm font-medium shadow-md hover:shadow-lg transform hover:scale-105" data-status="permission">
                        <i class="fas fa-hand-paper mb-1 block"></i>ขอลาเรียนทั้งหมด
                    </button>
                    <button class="bulk-btn bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-3 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-200 text-sm font-medium shadow-md hover:shadow-lg transform hover:scale-105" data-status="absent">
                        <i class="fas fa-times mb-1 block"></i>ขาดเรียนทั้งหมด
                    </button>
                </div>
            </div>

            <!-- Student List Card -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-orange-100">
                <div class="bg-gradient-to-r from-orange-500 to-yellow-500 px-6 py-4">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-list text-white"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white">รายชื่อนักเรียน</h3>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gradient-to-r from-orange-50 to-yellow-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-bold text-orange-800 uppercase tracking-wider border-r border-orange-200">รายชื่อ</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-orange-800 uppercase tracking-wider border-r border-orange-200">สถานะ</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-orange-800 uppercase tracking-wider border-r border-orange-200">หมายเหตุ</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-orange-800 uppercase tracking-wider">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="bg-white divide-y divide-orange-100">
                            <!-- Student rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Save Button -->
            <div class="mt-8 text-center">
                <button id="saveAttendanceBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-12 py-4 rounded-2xl hover:from-orange-600 hover:to-yellow-600 transition-all duration-200 text-xl font-bold shadow-xl hover:shadow-2xl transform hover:scale-105">
                    <i class="fas fa-save mr-3"></i>บันทึกการเช็คชื่อ
                </button>
            </div>
        </div>

        <!-- Summary Page -->
        <div id="summaryPage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header Section with Gradient Background -->
            <div class="bg-gradient-to-br from-yellow-400 via-orange-500 to-orange-600 rounded-2xl p-8 mb-8 shadow-xl">
                <div class="mb-6">
                    <button id="backToAttendance" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition-all duration-200 backdrop-blur-sm border border-white border-opacity-20">
                        <i class="fas fa-arrow-left mr-2"></i>กลับไปเช็คชื่อ
                    </button>
                </div>
                
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="text-white">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center mr-4 backdrop-blur-sm">
                                <i class="fas fa-chart-line text-2xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold">สรุปผลการเรียน</h2>
                                <p id="summaryClassName" class="text-lg text-yellow-100 mt-1"></p>
                            </div>
                        </div>
                    </div>
                    

                </div>
            </div>

            <!-- Legend Card -->
            <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-2xl shadow-lg p-6 mb-8 border border-orange-200">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-yellow-500 rounded-xl flex items-center justify-center mr-3">
                        <i class="fas fa-info-circle text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-orange-800">สัญลักษณ์การเข้าเรียน</h3>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="bg-white rounded-xl p-3 shadow-sm border border-orange-100 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center space-x-3">
                            <span class="inline-block w-8 h-8 rounded-full bg-green-500 text-white text-sm flex items-center justify-center font-bold shadow-sm">1</span>
                            <div>
                                <div class="font-semibold text-gray-800">มาเรียน</div>
                                <div class="text-xs text-gray-500">Present</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-3 shadow-sm border border-orange-100 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center space-x-3">
                            <span class="inline-block w-8 h-8 rounded-full bg-yellow-500 text-white text-sm flex items-center justify-center font-bold shadow-sm">ส</span>
                            <div>
                                <div class="font-semibold text-gray-800">มาสาย</div>
                                <div class="text-xs text-gray-500">Late</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-3 shadow-sm border border-orange-100 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center space-x-3">
                            <span class="inline-block w-8 h-8 rounded-full bg-orange-500 text-white text-sm flex items-center justify-center font-bold shadow-sm">ป</span>
                            <div>
                                <div class="font-semibold text-gray-800">ลาป่วย</div>
                                <div class="text-xs text-gray-500">Sick</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-3 shadow-sm border border-orange-100 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center space-x-3">
                            <span class="inline-block w-8 h-8 rounded-full bg-blue-500 text-white text-sm flex items-center justify-center font-bold shadow-sm">ก</span>
                            <div>
                                <div class="font-semibold text-gray-800">ลากิจ</div>
                                <div class="text-xs text-gray-500">Business</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-3 shadow-sm border border-orange-100 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center space-x-3">
                            <span class="inline-block w-8 h-8 rounded-full bg-purple-500 text-white text-sm flex items-center justify-center font-bold shadow-sm">ว</span>
                            <div>
                                <div class="font-semibold text-gray-800">ขอเวลาเรียน</div>
                                <div class="text-xs text-gray-500">Permission</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-3 shadow-sm border border-orange-100 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-center space-x-3">
                            <span class="inline-block w-8 h-8 rounded-full bg-gray-500 text-white text-sm flex items-center justify-center font-bold shadow-sm">ข</span>
                            <div>
                                <div class="font-semibold text-gray-800">ขาดเรียน</div>
                                <div class="text-xs text-gray-500">Absent</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table Card -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-orange-100">
                <div class="bg-gradient-to-r from-orange-500 to-yellow-500 px-6 py-4">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-table text-white"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white">ตารางสรุปการเข้าเรียน</h3>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gradient-to-r from-orange-50 to-yellow-50">
                            <tr id="summaryTableHeader">
                                <th class="px-6 py-4 text-left text-sm font-bold text-orange-800 uppercase tracking-wider sticky left-0 bg-gradient-to-r from-orange-50 to-yellow-50 border-r border-orange-200">รายชื่อ</th>
                                <!-- Date columns will be added dynamically -->
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody" class="bg-white divide-y divide-orange-100">
                            <!-- Summary rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Progress Bar Overlay -->
        <div id="progressOverlay" class="progress-overlay hidden">
            <div class="progress-content">
                <div class="mb-4">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-600 mb-2"></i>
                    <h3 class="text-lg font-semibold text-gray-900">กำลังสร้างห้องเรียน</h3>
                    <p class="text-sm text-gray-600 mt-1">กรุณารอสักครู่...</p>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-sm text-gray-600">เริ่มต้นการสร้าง...</div>
            </div>
        </div>

        <!-- Student Course Selection Page -->
        <div id="studentCourseSelectionPage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-6">
                <button id="backToLoginFromCourses" class="text-blue-600 hover:text-blue-800 mb-4">
                    <i class="fas fa-arrow-left mr-2"></i>กลับไปหน้าเข้าสู่ระบบ
                </button>
                <h2 class="text-3xl font-bold text-gray-900">เลือกรายวิชา</h2>
                <p id="studentInfoCourses" class="text-lg text-gray-600 mt-2"></p>
            </div>

            <div id="studentCoursesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Course cards will be populated here -->
            </div>
        </div>

        <!-- Student Attendance View -->
        <div id="studentAttendancePage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-6">
                <button id="backToCourseSelection" class="text-blue-600 hover:text-blue-800 mb-4">
                    <i class="fas fa-arrow-left mr-2"></i>กลับไปเลือกรายวิชา
                </button>
                <h2 class="text-3xl font-bold text-gray-900">ประวัติการเข้าเรียน</h2>
                <p id="studentInfo" class="text-lg text-gray-600 mt-2"></p>
            </div>

            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หมายเหตุ</th>
                            </tr>
                        </thead>
                        <tbody id="studentAttendanceBody" class="bg-white divide-y divide-gray-200">
                            <!-- Student attendance rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 text-white mt-auto relative overflow-hidden">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-10">
            <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='11' cy='11' r='2'/%3E%3Ccircle cx='49' cy='49' r='2'/%3E%3Ccircle cx='11' cy='49' r='2'/%3E%3Ccircle cx='49' cy='11' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
        </div>
        
        <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Main Footer Content -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                <!-- System Info -->
                <div class="text-center md:text-left">
                    <div class="flex items-center justify-center md:justify-start mb-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-yellow-500 rounded-xl flex items-center justify-center mr-3 shadow-lg">
                            <i class="fas fa-graduation-cap text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">ระบบเช็คชื่อรายวิชา</h3>
                            <p class="text-gray-400 text-sm">Attendance Management System</p>
                        </div>
                    </div>
                    <p class="text-gray-300 text-sm leading-relaxed">
                        ระบบจัดการการเช็คชื่อที่ทันสมัย ใช้งานง่าย และมีประสิทธิภาพสำหรับการศึกษา
                    </p>
                </div>

                <!-- Features -->
                <div class="text-left">
                    <h4 class="text-white font-semibold mb-4 flex items-center">
                        <i class="fas fa-star text-yellow-400 mr-2"></i>
                        คุณสมบัติเด่น
                    </h4>
                    <ul class="space-y-2 text-sm text-gray-300 list-disc list-inside">
                        <li>เช็คชื่อแบบเรียลไทม์</li>
                        <li>สรุปผลการเรียนอัตโนมัติ</li>
                        <li>Export Excel และ PDF</li>
                        <li>ระบบปลอดภัยสูง</li>
                    </ul>
                </div>

                <!-- Developer Info -->
                <div class="text-center md:text-right">
                    <h4 class="text-white font-semibold mb-4 flex items-center justify-center md:justify-end">
                        <i class="fas fa-code text-blue-400 mr-2"></i>
                        ผู้พัฒนาระบบ
                    </h4>
                    <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-4 border border-white border-opacity-20">
                        <div class="flex items-center justify-center md:justify-end mb-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user text-white text-sm"></i>
                            </div>
                            <div class="text-left">
                                <p class="text-white font-semibold text-sm">ครูอนุพงค์ คงสระ</p>
                                <p class="text-gray-300 text-xs">System Developer</p>
                            </div>
                        </div>
                        <a href="https://www.facebook.com/Anupong1907/" target="_blank" 
                           class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl">
                            <i class="fab fa-facebook-f mr-2"></i>
                            ติดต่อผ่าน Facebook
                        </a>
                    </div>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="border-t border-gray-700 pt-6">
                <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                    <!-- Copyright -->
                    <div class="flex items-center text-gray-400 text-sm">
                        <i class="fas fa-copyright mr-2"></i>
                        <span>2024 ระบบเช็คชื่อรายวิชา. สงวนลิขสิทธิ์.</span>
                    </div>

                    <!-- Tech Stack -->
                    <div class="flex items-center space-x-4 text-gray-400 text-sm">
                        <div class="flex items-center">
                            <i class="fab fa-html5 text-orange-500 mr-1"></i>
                            <span>HTML5</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fab fa-js-square text-yellow-500 mr-1"></i>
                            <span>JavaScript</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-database text-green-500 mr-1"></i>
                            <span>Firebase</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-mobile-alt text-blue-500 mr-1"></i>
                            <span>Responsive</span>
                        </div>
                    </div>

                    <!-- Version -->
                    <div class="flex items-center bg-gray-700 bg-opacity-50 rounded-full px-3 py-1">
                        <i class="fas fa-tag text-green-400 mr-2 text-xs"></i>
                        <span class="text-gray-300 text-xs font-medium">Version 2.0</span>
                    </div>
                </div>
            </div>

            <!-- Decorative Elements -->
            <div class="absolute top-0 left-0 w-32 h-32 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-full opacity-10 -translate-x-16 -translate-y-16"></div>
            <div class="absolute bottom-0 right-0 w-24 h-24 bg-gradient-to-tl from-blue-500 to-purple-500 rounded-full opacity-10 translate-x-12 translate-y-12"></div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
          // ✅ ใช้เวอร์ชันที่เสถียร (ถ้าเดิมใช้ 9.22.0 คงไว้เพื่อความเข้ากันได้)
  import { initializeApp }   from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth }         from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getDatabase }     from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  const LS_KEY = "firebaseConfig";  // key ใน localStorage

  // --- ตัวช่วย validate ---
  function validateConfig(cfg) {
    const required = ["apiKey","authDomain","projectId","appId"];
    const missing = required.filter(k => !cfg?.[k] || typeof cfg[k] !== "string" || cfg[k].trim() === "");
    const optional = ["databaseURL","storageBucket","messagingSenderId","measurementId"];
    return { ok: missing.length === 0, missing, optionalMissing: optional.filter(k => !cfg?.[k]) };
  }

  // --- หน้าต่างให้วาง JSON (ใช้ SweetAlert2 ถ้ามี; ถ้าไม่มีก็ตกกลับไปใช้ prompt) ---
  async function promptForConfig(existingText = "") {
    const sample = `{
  "apiKey": "YOUR_API_KEY",
  "authDomain": "YOUR_PROJECT_ID.firebaseapp.com",
  "databaseURL": "https://YOUR_DB_ID.asia-southeast1.firebasedatabase.app",
  "projectId": "YOUR_PROJECT_ID",
  "storageBucket": "YOUR_PROJECT_ID.appspot.com",
  "messagingSenderId": "YOUR_SENDER_ID",
  "appId": "YOUR_APP_ID",
  "measurementId": "G-XXXXXXX"
}`;

    // ถ้ามี SweetAlert2
    if (typeof window.Swal !== "undefined") {
      const { value: text } = await Swal.fire({
        title: 'วาง Firebase Config (JSON)',
        input: 'textarea',
        inputValue: existingText || sample,
        inputAttributes: { 'aria-label': 'Firebase config JSON' },
        confirmButtonText: 'บันทึก',
        cancelButtonText: 'ยกเลิก',
        showCancelButton: true,
        inputAutoTrim: false,
        preConfirm: (value) => {
          try {
            const cfg = JSON.parse(value);
            const res = validateConfig(cfg);
            if (!res.ok) throw new Error('คีย์ที่จำเป็นขาด: ' + res.missing.join(', '));
            return value;
          } catch (err) {
            Swal.showValidationMessage(err.message);
          }
        },
        allowOutsideClick: () => !Swal.isLoading()
      });
      if (!text) throw new Error('ผู้ใช้ยกเลิกการตั้งค่า');
      localStorage.setItem(LS_KEY, text);
      return text;
    }

    // ถ้าไม่มี SweetAlert2 (fallback)
    const text = prompt("วาง Firebase config (JSON):", existingText || sample);
    if (!text) throw new Error("ผู้ใช้ยกเลิกหรือไม่ใส่ค่า");
    try {
      const cfg = JSON.parse(text);
      const res = validateConfig(cfg);
      if (!res.ok) throw new Error("คีย์ที่จำเป็นขาด: " + res.missing.join(", "));
      localStorage.setItem(LS_KEY, text);
      return text;
    } catch (e) {
      alert("JSON ไม่ถูกต้อง: " + e.message);
      return await promptForConfig(existingText);
    }
  }

  async function ensureFirebaseConfig() {
    let raw = localStorage.getItem(LS_KEY);
    if (!raw) {
      raw = await promptForConfig();
    }
    let cfg;
    try {
      cfg = JSON.parse(raw);
    } catch (e) {
      if (typeof window.Swal !== "undefined") {
        await Swal.fire({ icon: 'error', title: 'JSON ไม่ถูกต้อง', text: e.message });
      } else {
        alert("JSON ไม่ถูกต้อง: " + e.message);
      }
      localStorage.removeItem(LS_KEY);
      return await ensureFirebaseConfig();
    }
    const res = validateConfig(cfg);
    if (!res.ok) {
      if (typeof window.Swal !== "undefined") {
        await Swal.fire({ icon: 'error', title: 'คอนฟิกยังไม่ครบ', text: 'ขาด: ' + res.missing.join(', ') });
      } else {
        alert("คอนฟิกยังไม่ครบ: " + res.missing.join(", "));
      }
      localStorage.removeItem(LS_KEY);
      return await ensureFirebaseConfig();
    }
    return cfg;
  }

  function wireConfigButtons() {
    // ปุ่ม “ตั้งค่า/แก้ไข”
    const btnSet = document.getElementById('btn-change-config');
    if (btnSet) {
      btnSet.addEventListener('click', async () => {
        try {
          const current = localStorage.getItem(LS_KEY) || "";
          await promptForConfig(current);
          location.reload(); // รีโหลดเพื่อให้ init ใหม่ตามคอนฟิก
        } catch (_) {}
      });
    }
    // ปุ่ม “ดูคอนฟิก”
    const btnView = document.getElementById('btn-view-config');
    if (btnView) {
      btnView.addEventListener('click', () => {
        const current = localStorage.getItem(LS_KEY);
        if (typeof window.Swal !== "undefined") {
          Swal.fire({ title:'ดูคอนฟิก (อ่านอย่างเดียว)', input: 'textarea', inputValue: current || 'ยังไม่ตั้งค่า', showConfirmButton: false });
        } else {
          alert(current || "ยังไม่ตั้งค่า");
        }
      });
    }
    // ปุ่ม “ลบคอนฟิก”
    const btnReset = document.getElementById('btn-reset-config');
    if (btnReset) {
      btnReset.addEventListener('click', async () => {
        const doReset = typeof window.Swal !== "undefined"
          ? (await Swal.fire({ icon: 'warning', title: 'ลบคอนฟิกจากเครื่องนี้?', text: 'ต้องวางใหม่ในการใช้งานครั้งถัดไป', showCancelButton: true, confirmButtonText: 'ลบ', cancelButtonText: 'ยกเลิก' })).isConfirmed
          : confirm("ลบคอนฟิกจากเครื่องนี้?");
        if (doReset) {
          localStorage.removeItem(LS_KEY);
          location.reload();
        }
      });
    }
  }

  (async () => {
    try {
      const cfg = await ensureFirebaseConfig();
      // ✅ เริ่มต้น Firebase ด้วยคอนฟิกที่ผู้ใช้เพิ่งตั้งค่า
      const app = initializeApp(cfg);
      const auth = getAuth(app);
      const db   = getDatabase(app);

      // เผื่อโค้ดส่วนอื่นต้องเข้าถึง
      window.firebaseApp = app;
      window.firebaseAuth = auth;
      window.firebaseDb = db;

      wireConfigButtons();

      // ===== โค้ดฟีเจอร์เดิมของคุณวางต่อจากนี้ได้เลย =====
      // ตัวอย่าง: runApp({ app, auth, db });

      console.log("✅ Firebase initialized:", cfg.projectId);
    } catch (e) {
      console.error(e);
      if (typeof window.Swal !== "undefined") {
        await Swal.fire({ icon: 'error', title: 'เริ่มระบบไม่สำเร็จ', text: e.message });
      } else {
        alert("เริ่มระบบไม่สำเร็จ: " + e.message);
      }
    }
  })();

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let currentUser = null;
        let currentCourseId = null;
        let currentStudents = {};
        let attendanceData = {};

        // Status configurations
        const statusConfig = {
            present: { label: 'มาเรียน', color: 'bg-green-600', rowClass: 'row-present', symbol: '1' },
            late: { label: 'มาสาย', color: 'bg-yellow-600', rowClass: 'row-late', symbol: 'ส' },
            sick: { label: 'ลาป่วย', color: 'bg-orange-600', rowClass: 'row-sick', symbol: 'ป' },
            business: { label: 'ลากิจ', color: 'bg-blue-600', rowClass: 'row-business', symbol: 'ก' },
            permission: { label: 'ขอเวลาเรียน', color: 'bg-purple-600', rowClass: 'row-permission', symbol: 'ว' },
            absent: { label: 'ขาดเรียน', color: 'bg-gray-600', rowClass: 'row-absent', symbol: 'ข' }
        };

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const classListPage = document.getElementById('classListPage');
        const attendancePage = document.getElementById('attendancePage');
        const summaryPage = document.getElementById('summaryPage');
        const studentCourseSelectionPage = document.getElementById('studentCourseSelectionPage');
        const studentAttendancePage = document.getElementById('studentAttendancePage');
        const createClassModal = document.getElementById('createClassModal');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('attendanceDate').valueAsDate = new Date();

            // Tab switching
            document.getElementById('teacherTab').addEventListener('click', () => switchTab('teacher'));
            document.getElementById('studentTab').addEventListener('click', () => switchTab('student'));
            
            // Register/Login switching
            document.getElementById('showRegisterBtn').addEventListener('click', () => switchTab('register'));
            document.getElementById('showLoginBtn').addEventListener('click', () => switchTab('teacher'));

            // Teacher login and registration
            document.getElementById('teacherLoginForm').addEventListener('submit', handleTeacherLogin);
            document.getElementById('teacherRegisterForm').addEventListener('submit', handleTeacherRegister);
            document.getElementById('forgotPasswordBtn').addEventListener('click', handleForgotPassword);

            // Student portal
            document.getElementById('viewAttendanceBtn').addEventListener('click', handleStudentView);

            // Class management
            document.getElementById('createClassBtn').addEventListener('click', () => {
                createClassModal.classList.remove('hidden');
                createClassModal.classList.add('flex');
            });

            document.getElementById('cancelCreateClass').addEventListener('click', () => {
                createClassModal.classList.add('hidden');
                createClassModal.classList.remove('flex');
            });

            document.getElementById('createClassForm').addEventListener('submit', handleCreateClass);

            // Navigation
            document.getElementById('backToClassList').addEventListener('click', () => showPage('classList'));
            document.getElementById('backToAttendance').addEventListener('click', () => showPage('attendance'));
            document.getElementById('backToLoginFromCourses').addEventListener('click', () => showPage('login'));
            document.getElementById('backToCourseSelection').addEventListener('click', () => showPage('studentCourseSelection'));
            document.getElementById('summaryBtn').addEventListener('click', () => showSummaryPage());



            // Student management
            document.getElementById('manageStudentsBtn').addEventListener('click', openManageStudentsModal);
            document.getElementById('closeManageStudents').addEventListener('click', closeManageStudentsModal);
            document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
            document.getElementById('saveStudentChanges').addEventListener('click', saveStudentChanges);
            document.getElementById('editStudentForm').addEventListener('submit', handleEditStudent);
            document.getElementById('cancelEditStudent').addEventListener('click', closeEditStudentModal);
            document.getElementById('editClassNameBtn').addEventListener('click', editClassName);
            document.getElementById('cancelStudentChanges').addEventListener('click', closeManageStudentsModal);

            // Archive management
            document.getElementById('showArchivedBtn').addEventListener('click', showArchivedClasses);
            document.getElementById('closeArchivedClasses').addEventListener('click', closeArchivedClasses);

            // Attendance actions
            document.getElementById('saveAttendanceBtn').addEventListener('click', saveAttendance);
            document.querySelectorAll('.bulk-btn').forEach(btn => {
                btn.addEventListener('click', (e) => bulkSetStatus(e.target.dataset.status));
            });

            // Date change
            document.getElementById('attendanceDate').addEventListener('change', loadAttendanceForDate);

            // User profile dropdown
            document.getElementById('userProfileBtn').addEventListener('click', toggleUserDropdown);
            document.getElementById('editProfileBtn').addEventListener('click', openEditProfileModal);
            document.getElementById('changePasswordBtn').addEventListener('click', openChangePasswordModal);
            document.getElementById('cancelEditProfile').addEventListener('click', closeEditProfileModal);
            document.getElementById('cancelChangePassword').addEventListener('click', closeChangePasswordModal);
            document.getElementById('editProfileForm').addEventListener('submit', handleEditProfile);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('userDropdown');
                const button = document.getElementById('userProfileBtn');
                if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Navbar buttons
            document.getElementById('navLoginBtn').addEventListener('click', () => {
                showPage('login');
                switchTab('teacher');
            });
            document.getElementById('navRegisterBtn').addEventListener('click', () => {
                showPage('login');
                switchTab('register');
            });

            // Auth state observer
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    updateUserInfo(user);
                    document.getElementById('guestNav').classList.add('hidden');
                    document.getElementById('userNav').classList.remove('hidden');
                    showPage('classList');
                    loadClasses();
                } else {
                    currentUser = null;
                    document.getElementById('userEmail').textContent = '';
                    document.getElementById('guestNav').classList.remove('hidden');
                    document.getElementById('userNav').classList.add('hidden');
                    showPage('login');
                }
            });
        });

        function switchTab(tab) {
            const teacherTab = document.getElementById('teacherTab');
            const studentTab = document.getElementById('studentTab');
            const teacherLogin = document.getElementById('teacherLogin');
            const teacherRegister = document.getElementById('teacherRegister');
            const studentLogin = document.getElementById('studentLogin');
            const tabIndicator = document.getElementById('tabIndicator');

            // Reset all tabs
            [teacherTab, studentTab].forEach(tabEl => {
                tabEl.classList.remove('text-blue-600', 'text-green-600');
                tabEl.classList.add('text-gray-500');
            });

            // Hide all forms
            [teacherLogin, teacherRegister, studentLogin].forEach(form => {
                form.classList.add('hidden');
            });

            // Show selected tab and form with animation
            if (tab === 'teacher') {
                teacherTab.classList.add('text-blue-600');
                teacherTab.classList.remove('text-gray-500');
                teacherLogin.classList.remove('hidden');
                tabIndicator.style.transform = 'translateX(0%)';
            } else if (tab === 'register') {
                // No tab highlighting for register, just show form
                teacherRegister.classList.remove('hidden');
            } else if (tab === 'student') {
                studentTab.classList.add('text-green-600');
                studentTab.classList.remove('text-gray-500');
                studentLogin.classList.remove('hidden');
                tabIndicator.style.transform = 'translateX(100%)';
            }
        }

        async function handleTeacherLogin(e) {
            e.preventDefault();
            const email = document.getElementById('teacherEmail').value;
            const password = document.getElementById('teacherPassword').value;

            try {
                // Show loading
                Swal.fire({
                    title: 'กำลังเข้าสู่ระบบ...',
                    html: `
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-orange-100 rounded-full mb-4">
                                <i class="fas fa-spinner fa-spin text-2xl text-orange-600"></i>
                            </div>
                            <p class="text-gray-600">กรุณารอสักครู่...</p>
                        </div>
                    `,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    width: '350px'
                });

                await signInWithEmailAndPassword(auth, email, password);
                
                // Success will be handled by auth state observer
                Swal.close();
                
            } catch (error) {
                let errorTitle = 'เข้าสู่ระบบไม่สำเร็จ';
                let errorMessage = '';
                let errorDetails = '';
                let iconColor = '#ef4444';

                switch (error.code) {
                    case 'auth/user-not-found':
                        errorTitle = 'ไม่พบบัญชีผู้ใช้';
                        errorMessage = 'ไม่มีบัญชีที่ใช้อีเมลนี้ในระบบ';
                        errorDetails = 'กรุณาตรวจสอบอีเมลให้ถูกต้อง หรือสมัครสมาชิกใหม่';
                        break;
                    case 'auth/wrong-password':
                        errorTitle = 'รหัสผ่านไม่ถูกต้อง';
                        errorMessage = 'รหัสผ่านที่กรอกไม่ตรงกับบัญชีนี้';
                        errorDetails = 'กรุณาตรวจสอบรหัสผ่านให้ถูกต้อง หรือใช้ฟีเจอร์ลืมรหัสผ่าน';
                        break;
                    case 'auth/invalid-email':
                        errorTitle = 'รูปแบบอีเมลไม่ถูกต้อง';
                        errorMessage = 'กรุณากรอกอีเมลในรูปแบบที่ถูกต้อง';
                        errorDetails = 'ตัวอย่าง: example@email.com';
                        break;
                    case 'auth/user-disabled':
                        errorTitle = 'บัญชีถูกระงับ';
                        errorMessage = 'บัญชีนี้ถูกระงับการใช้งาน';
                        errorDetails = 'กรุณาติดต่อผู้ดูแลระบบ';
                        break;
                    case 'auth/too-many-requests':
                        errorTitle = 'พยายามเข้าสู่ระบบมากเกินไป';
                        errorMessage = 'มีการพยายามเข้าสู่ระบบผิดหลายครั้ง';
                        errorDetails = 'กรุณารอสักครู่แล้วลองใหม่อีกครั้ง';
                        iconColor = '#f59e0b';
                        break;
                    case 'auth/network-request-failed':
                        errorTitle = 'ปัญหาการเชื่อมต่อ';
                        errorMessage = 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้';
                        errorDetails = 'กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต';
                        iconColor = '#f59e0b';
                        break;
                    default:
                        errorMessage = 'เกิดข้อผิดพลาดที่ไม่คาดคิด';
                        errorDetails = error.message;
                }

                await Swal.fire({
                    icon: 'error',
                    html: `
                        <div class="text-left space-y-4">
                            <!-- Error Header -->
                            <div class="text-center mb-6">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-red-100 rounded-full mb-4">
                                    <i class="fas fa-exclamation-circle text-3xl text-red-600"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-red-600 mb-2">${errorTitle}</h3>
                                <p class="text-gray-600">${errorMessage}</p>
                            </div>

                            <!-- Login Attempt Info -->
                            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                <div class="flex items-center mb-3">
                                    <div class="w-10 h-10 bg-gray-500 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    <h4 class="font-semibold text-gray-800">ข้อมูลที่พยายามเข้าสู่ระบบ</h4>
                                </div>
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="text-sm text-gray-600 mb-1">อีเมล</div>
                                    <div class="font-mono text-gray-800">${email}</div>
                                </div>
                            </div>

                            <!-- Error Details -->
                            <div class="bg-red-50 rounded-xl p-4 border border-red-200">
                                <div class="flex items-center mb-2">
                                    <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-info-circle text-white text-sm"></i>
                                    </div>
                                    <span class="font-semibold text-red-800">รายละเอียด</span>
                                </div>
                                <p class="text-red-700 text-sm">${errorDetails}</p>
                            </div>

                            <!-- Solutions -->
                            <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                                <div class="flex items-center mb-3">
                                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-lightbulb text-white text-sm"></i>
                                    </div>
                                    <span class="font-semibold text-blue-800">แนะนำการแก้ไข</span>
                                </div>
                                <ul class="text-blue-700 text-sm space-y-2 list-disc list-inside">
                                    ${error.code === 'auth/user-not-found' ? `
                                        <li>ตรวจสอบการสะกดอีเมลให้ถูกต้อง</li>
                                        <li>ลองใช้อีเมลอื่นที่เคยลงทะเบียนไว้</li>
                                        <li>หากยังไม่มีบัญชี กรุณาสมัครสมาชิกใหม่</li>
                                    ` : error.code === 'auth/wrong-password' ? `
                                        <li>ตรวจสอบรหัสผ่านให้ถูกต้อง</li>
                                        <li>ตรวจสอบ Caps Lock ว่าเปิดอยู่หรือไม่</li>
                                        <li>ใช้ฟีเจอร์ "ลืมรหัสผ่าน" หากจำไม่ได้</li>
                                    ` : error.code === 'auth/invalid-email' ? `
                                        <li>ตรวจสอบรูปแบบอีเมลให้ถูกต้อง</li>
                                        <li>ต้องมี @ และ domain name</li>
                                        <li>ไม่มีช่องว่างหรืออักขระพิเศษ</li>
                                    ` : `
                                        <li>ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต</li>
                                        <li>ลองรีเฟรชหน้าเว็บ</li>
                                        <li>ติดต่อผู้ดูแลระบบหากปัญหายังคงอยู่</li>
                                    `}
                                </ul>
                            </div>

                            <!-- Quick Actions -->
                            <div class="bg-green-50 rounded-xl p-4 border border-green-200">
                                <div class="flex items-center mb-3">
                                    <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-tools text-white text-sm"></i>
                                    </div>
                                    <span class="font-semibold text-green-800">การดำเนินการด่วน</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    ${error.code === 'auth/wrong-password' ? `
                                        <button id="quickForgotPassword" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center justify-center">
                                            <i class="fas fa-key mr-2"></i>ลืมรหัสผ่าน
                                        </button>
                                    ` : ''}
                                    ${error.code === 'auth/user-not-found' ? `
                                        <button id="quickRegister" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center justify-center">
                                            <i class="fas fa-user-plus mr-2"></i>สมัครสมาชิก
                                        </button>
                                    ` : ''}
                                    <button id="quickRetry" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center justify-center">
                                        <i class="fas fa-redo mr-2"></i>ลองใหม่
                                    </button>
                                </div>
                            </div>
                        </div>
                    `,
                    confirmButtonText: '<i class="fas fa-times mr-2"></i>ปิด',
                    confirmButtonColor: iconColor,
                    width: '700px',
                    padding: '2rem',
                    showClass: {
                        popup: 'animate__animated animate__shakeX'
                    },
                    hideClass: {
                        popup: 'animate__animated animate__fadeOutUp'
                    },
                    customClass: {
                        popup: 'rounded-2xl shadow-2xl',
                        confirmButton: 'rounded-xl px-6 py-3 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200'
                    },
                    backdrop: `
                        rgba(0,0,0,0.6)
                        url("data:image/svg+xml,%3csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3e%3cg fill='none' fill-rule='evenodd'%3e%3cg fill='%23ef4444' fill-opacity='0.1'%3e%3ccircle cx='30' cy='30' r='4'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e")
                        center/400px
                    `,
                    didOpen: () => {
                        // Add event listeners for quick action buttons
                        const quickForgotPassword = document.getElementById('quickForgotPassword');
                        const quickRegister = document.getElementById('quickRegister');
                        const quickRetry = document.getElementById('quickRetry');

                        if (quickForgotPassword) {
                            quickForgotPassword.addEventListener('click', () => {
                                Swal.close();
                                handleForgotPassword();
                            });
                        }

                        if (quickRegister) {
                            quickRegister.addEventListener('click', () => {
                                Swal.close();
                                switchTab('register');
                            });
                        }

                        if (quickRetry) {
                            quickRetry.addEventListener('click', () => {
                                Swal.close();
                                // Focus on the appropriate field based on error
                                if (error.code === 'auth/wrong-password') {
                                    document.getElementById('teacherPassword').focus();
                                    document.getElementById('teacherPassword').select();
                                } else {
                                    document.getElementById('teacherEmail').focus();
                                    document.getElementById('teacherEmail').select();
                                }
                            });
                        }
                    }
                });

                // Clear password field for security
                document.getElementById('teacherPassword').value = '';
            }
        }

        async function handleTeacherRegister(e) {
            e.preventDefault();
            const fullName = document.getElementById('teacherFullName').value.trim();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                alert('รหัสผ่านไม่ตรงกัน กรุณาตรวจสอบอีกครั้ง');
                return;
            }

            // Validate password length
            if (password.length < 6) {
                alert('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }

            try {
                // Create user account
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Update user profile with display name
                await updateProfile(user, {
                    displayName: fullName
                });

                // Save teacher profile to database
                const teacherRef = ref(database, `teachers/${user.uid}`);
                await set(teacherRef, {
                    fullName: fullName,
                    email: email,
                    createdAt: new Date().toISOString()
                });

                alert('สมัครสมาชิกสำเร็จ! กำลังเข้าสู่ระบบ...');
                
                // Clear form
                document.getElementById('teacherRegisterForm').reset();
                
            } catch (error) {
                let errorMessage = 'สมัครสมาชิกไม่สำเร็จ: ';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += 'อีเมลนี้ถูกใช้งานแล้ว';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'รูปแบบอีเมลไม่ถูกต้อง';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'รหัสผ่านไม่ปลอดภัย';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                alert(errorMessage);
            }
        }

        async function handleForgotPassword() {
            const { value: email } = await Swal.fire({
                title: '🔑 ลืมรหัสผ่าน',
                html: `
                    <div class="text-left space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                <span class="font-semibold text-blue-800">วิธีการรีเซ็ตรหัสผ่าน</span>
                            </div>
                            <p class="text-sm text-blue-700">กรอกอีเมลที่ใช้ลงทะเบียน เราจะส่งลิงก์สำหรับรีเซ็ตรหัสผ่านไปให้คุณ</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600 text-sm mb-3">กรุณากรอกอีเมลของคุณ</p>
                        </div>
                    </div>
                `,
                input: 'email',
                inputPlaceholder: 'กรอกอีเมลที่ลงทะเบียนไว้',
                inputAttributes: {
                    autocapitalize: 'off',
                    autocorrect: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'ส่งลิงก์รีเซ็ต',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#8b5cf6',
                cancelButtonColor: '#6b7280',
                inputValidator: (value) => {
                    if (!value) {
                        return 'กรุณากรอกอีเมล';
                    }
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                        return 'รูปแบบอีเมลไม่ถูกต้อง';
                    }
                },
                customClass: {
                    popup: 'rounded-2xl',
                    title: 'text-xl font-bold',
                    confirmButton: 'rounded-lg px-6 py-2',
                    cancelButton: 'rounded-lg px-6 py-2'
                }
            });

            if (email) {
                try {
                    // Show loading
                    Swal.fire({
                        title: 'กำลังส่งอีเมล...',
                        html: `
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-100 rounded-full mb-4">
                                    <i class="fas fa-paper-plane text-2xl text-purple-600 animate-pulse"></i>
                                </div>
                                <p class="text-gray-600">กำลังส่งลิงก์รีเซ็ตรหัสผ่านไปยัง</p>
                                <p class="font-semibold text-purple-600 mt-1">${email}</p>
                            </div>
                        `,
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Send password reset email
                    await sendPasswordResetEmail(auth, email);

                    // Show success message
                    await Swal.fire({
                        icon: 'success',
                        title: '✅ ส่งอีเมลสำเร็จ!',
                        html: `
                            <div class="text-left space-y-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <span class="font-semibold text-green-800">ส่งลิงก์รีเซ็ตแล้ว</span>
                                    </div>
                                    <p class="text-sm text-green-700">เราได้ส่งลิงก์สำหรับรีเซ็ตรหัสผ่านไปยัง:</p>
                                    <p class="font-semibold text-green-800 mt-1">${email}</p>
                                </div>
                                
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                        <span class="font-semibold text-yellow-800">ขั้นตอนต่อไป</span>
                                    </div>
                                    <ol class="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                                        <li>ตรวจสอบอีเมลของคุณ (รวมถึงโฟลเดอร์ Spam)</li>
                                        <li>คลิกลิงก์ในอีเมลเพื่อรีเซ็ตรหัสผ่าน</li>
                                        <li>ตั้งรหัสผ่านใหม่</li>
                                        <li>กลับมาเข้าสู่ระบบด้วยรหัสผ่านใหม่</li>
                                    </ol>
                                </div>
                                
                                <div class="text-center">
                                    <p class="text-xs text-gray-500">หากไม่ได้รับอีเมล กรุณาตรวจสอบโฟลเดอร์ Spam หรือลองใหม่อีกครั้ง</p>
                                </div>
                            </div>
                        `,
                        confirmButtonText: 'เข้าใจแล้ว',
                        confirmButtonColor: '#10b981',
                        width: '500px',
                        customClass: {
                            popup: 'rounded-2xl',
                            title: 'text-xl font-bold',
                            confirmButton: 'rounded-lg px-6 py-2'
                        }
                    });

                } catch (error) {
                    let errorMessage = 'ไม่สามารถส่งอีเมลรีเซ็ตรหัสผ่านได้';
                    let errorDetails = '';

                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'ไม่พบอีเมลนี้ในระบบ';
                            errorDetails = 'กรุณาตรวจสอบอีเมลให้ถูกต้อง หรือสมัครสมาชิกใหม่';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
                            errorDetails = 'กรุณากรอกอีเมลในรูปแบบที่ถูกต้อง';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'ส่งคำขอมากเกินไป';
                            errorDetails = 'กรุณารอสักครู่แล้วลองใหม่อีกครั้ง';
                            break;
                        default:
                            errorDetails = error.message;
                    }

                    await Swal.fire({
                        icon: 'error',
                        title: '❌ เกิดข้อผิดพลาด',
                        html: `
                            <div class="text-left space-y-4">
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-times-circle text-red-600 mr-2"></i>
                                        <span class="font-semibold text-red-800">${errorMessage}</span>
                                    </div>
                                    <p class="text-sm text-red-700">${errorDetails}</p>
                                </div>
                                
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-lightbulb text-blue-600 mr-2"></i>
                                        <span class="font-semibold text-blue-800">แนะนำ</span>
                                    </div>
                                    <ul class="text-sm text-blue-700 space-y-1 list-disc list-inside">
                                        <li>ตรวจสอบการสะกดอีเมลให้ถูกต้อง</li>
                                        <li>ใช้อีเมลที่ลงทะเบียนไว้กับระบบ</li>
                                        <li>หากยังไม่มีบัญชี กรุณาสมัครสมาชิกก่อน</li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        confirmButtonText: 'ลองใหม่',
                        confirmButtonColor: '#ef4444',
                        width: '500px',
                        customClass: {
                            popup: 'rounded-2xl',
                            title: 'text-xl font-bold',
                            confirmButton: 'rounded-lg px-6 py-2'
                        }
                    });
                }
            }
        }

        let currentStudentId = null;
        let studentCourses = [];

        async function handleStudentView() {
            const studentId = document.getElementById('studentId').value.trim();

            if (!studentId) {
                alert('กรุณากรอกรหัสนักเรียน');
                return;
            }

            try {
                // Show loading
                Swal.fire({
                    title: 'กำลังค้นหา...',
                    text: 'กำลังค้นหาข้อมูลนักเรียน',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Search for student in all courses
                const coursesRef = ref(database, 'courses');
                const coursesSnapshot = await get(coursesRef);
                
                studentCourses = [];
                currentStudentId = studentId;

                if (coursesSnapshot.exists()) {
                    const courses = coursesSnapshot.val();
                    
                    for (const [courseId, courseData] of Object.entries(courses)) {
                        // Check if student exists in this course
                        const studentRef = ref(database, `students/${courseId}/${studentId}`);
                        const studentSnapshot = await get(studentRef);

                        if (studentSnapshot.exists()) {
                            const studentData = studentSnapshot.val();
                            studentCourses.push({
                                courseId: courseId,
                                courseData: courseData,
                                studentData: studentData
                            });
                        }
                    }
                }

                Swal.close();

                if (studentCourses.length === 0) {
                    await Swal.fire({
                        icon: 'warning',
                        html: `
                            <div class="text-center space-y-4">
                                <!-- Warning Icon -->
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-yellow-100 rounded-full mb-4">
                                    <i class="fas fa-search text-3xl text-yellow-600"></i>
                                </div>
                                
                                <!-- Title -->
                                <h3 class="text-2xl font-bold text-yellow-600 mb-2">ไม่พบข้อมูลนักเรียน</h3>
                                
                                <!-- Student ID Display -->
                                <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-200">
                                    <div class="flex items-center justify-center mb-2">
                                        <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-id-card text-white"></i>
                                        </div>
                                        <div>
                                            <div class="text-yellow-800 font-semibold">รหัสนักเรียนที่ค้นหา</div>
                                            <div class="text-yellow-700 font-mono text-lg">${studentId}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Possible Reasons -->
                                <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                                    <div class="flex items-center mb-3">
                                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-question-circle text-white text-sm"></i>
                                        </div>
                                        <span class="font-semibold text-blue-800">สาเหตุที่เป็นไปได้</span>
                                    </div>
                                    <ul class="text-sm text-blue-700 space-y-2 list-disc list-inside text-left">
                                        <li>รหัสนักเรียนยังไม่ได้ถูกเพิ่มเข้าในระบบ</li>
                                        <li>รหัสนักเรียนอาจจะสะกดผิด</li>
                                        <li>ครูยังไม่ได้สร้างห้องเรียนสำหรับนักเรียนคนนี้</li>
                                        <li>นักเรียนอาจจะถูกลบออกจากระบบแล้ว</li>
                                    </ul>
                                </div>
                                
                                <!-- Suggestions -->
                                <div class="bg-green-50 rounded-xl p-4 border border-green-200">
                                    <div class="flex items-center mb-3">
                                        <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-lightbulb text-white text-sm"></i>
                                        </div>
                                        <span class="font-semibold text-green-800">คำแนะนำ</span>
                                    </div>
                                    <ul class="text-sm text-green-700 space-y-2 list-disc list-inside text-left">
                                        <li>ตรวจสอบการสะกดรหัสนักเรียนให้ถูกต้อง</li>
                                        <li>ติดต่อครูผู้สอนเพื่อเพิ่มรหัสนักเรียนเข้าระบบ</li>
                                        <li>ลองค้นหาด้วยรหัสนักเรียนที่แตกต่างกัน</li>
                                        <li>ตรวจสอบว่าได้เรียนในรายวิชานี้หรือไม่</li>
                                    </ul>
                                </div>
                                
                                <!-- Contact Info -->
                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                    <div class="flex items-center justify-center">
                                        <div class="w-8 h-8 bg-gray-500 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-phone text-white text-sm"></i>
                                        </div>
                                        <div class="text-left">
                                            <p class="text-gray-800 font-semibold text-sm">ต้องการความช่วยเหลือ?</p>
                                            <p class="text-gray-600 text-xs">ติดต่อครูผู้สอนหรือผู้ดูแลระบบ</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `,
                        confirmButtonText: '<i class="fas fa-search mr-2"></i>ค้นหาใหม่',
                        showCancelButton: true,
                        cancelButtonText: '<i class="fas fa-home mr-2"></i>กลับหน้าหลัก',
                        confirmButtonColor: '#f59e0b',
                        cancelButtonColor: '#6b7280',
                        width: '600px',
                        padding: '2rem',
                        showClass: {
                            popup: 'animate__animated animate__fadeInDown'
                        },
                        hideClass: {
                            popup: 'animate__animated animate__fadeOutUp'
                        },
                        customClass: {
                            popup: 'rounded-2xl shadow-2xl',
                            confirmButton: 'rounded-xl px-6 py-3 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200',
                            cancelButton: 'rounded-xl px-6 py-3 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200'
                        },
                        backdrop: `
                            rgba(0,0,0,0.6)
                            url("data:image/svg+xml,%3csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3e%3cg fill='none' fill-rule='evenodd'%3e%3cg fill='%23f59e0b' fill-opacity='0.1'%3e%3ccircle cx='30' cy='30' r='4'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e")
                            center/400px
                        `
                    });

                    // Clear the input field for new search
                    document.getElementById('studentId').value = '';
                    document.getElementById('studentId').focus();
                    return;
                }

                if (studentCourses.length === 1) {
                    // Only one course, go directly to attendance
                    viewStudentAttendance(studentCourses[0].courseId, studentCourses[0].courseData, studentCourses[0].studentData);
                } else {
                    // Multiple courses, show selection page
                    showStudentCourseSelection();
                }

            } catch (error) {
                Swal.close();
                alert('เกิดข้อผิดพลาด: ' + error.message);
            }
        }

        function showStudentCourseSelection() {
            // Show student info
            const firstCourse = studentCourses[0];
            document.getElementById('studentInfoCourses').innerHTML = `
                <div class="bg-gradient-to-r from-gray-600 to-slate-700 rounded-lg p-4 shadow-lg mb-6">
                    <div class="flex items-center mb-4">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-white bg-opacity-15 rounded-lg mr-3">
                            <i class="fas fa-user-graduate text-xl text-white"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-white">ข้อมูลนักเรียน</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <div class="bg-white bg-opacity-10 rounded-lg p-3">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-white text-sm"></i>
                                </div>
                                <div>
                                    <div class="text-gray-200 text-xs font-medium">ชื่อ-นามสกุล</div>
                                    <div class="text-white text-sm font-semibold">${firstCourse.studentData.prefix}${firstCourse.studentData.firstName} ${firstCourse.studentData.lastName}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white bg-opacity-10 rounded-lg p-3">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-3">
                                    <i class="fas fa-id-card text-white text-sm"></i>
                                </div>
                                <div>
                                    <div class="text-gray-200 text-xs font-medium">รหัสนักเรียน</div>
                                    <div class="text-white text-sm font-semibold font-mono">${currentStudentId}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 text-center">
                        <div class="flex items-center justify-center mb-2">
                            <div class="w-6 h-6 bg-green-500 bg-opacity-80 rounded-full flex items-center justify-center mr-2">
                                <i class="fas fa-check text-white text-xs"></i>
                            </div>
                            <div class="text-gray-200 text-xs font-medium">พบ ${studentCourses.length} รายวิชา</div>
                        </div>
                        <div class="text-gray-300 text-xs">เลือกรายวิชาที่ต้องการดูประวัติการเข้าเรียน</div>
                    </div>
                </div>
            `;

            // Render course cards
            const coursesList = document.getElementById('studentCoursesList');
            coursesList.innerHTML = '';

            studentCourses.forEach((course, index) => {
                const gradientClass = `gradient-bg-${(index % 6) + 1}`;
                const card = document.createElement('div');
                card.className = `${gradientClass} rounded-lg shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer text-white p-6 transform hover:scale-105`;
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas fa-book-open text-2xl opacity-80"></i>
                        <span class="text-sm opacity-80 bg-white bg-opacity-20 px-2 py-1 rounded">${course.courseData.code}</span>
                    </div>
                    <h3 class="text-xl font-bold mb-2">${course.courseData.name}</h3>
                    <div class="flex items-center text-sm opacity-90">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        <span>คลิกเพื่อดูประวัติการเข้าเรียน</span>
                    </div>
                `;
                card.addEventListener('click', () => {
                    viewStudentAttendance(course.courseId, course.courseData, course.studentData);
                });
                coursesList.appendChild(card);
            });

            showPage('studentCourseSelection');
        }

        async function viewStudentAttendance(courseId, courseData, studentData) {
            try {
                // Show loading
                Swal.fire({
                    title: 'กำลังโหลด...',
                    text: 'กำลังโหลดประวัติการเข้าเรียน',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Remove the old student info section since it's now in the summary
                document.getElementById('studentInfo').innerHTML = '';

                // Load attendance data
                const attendanceRef = ref(database, `attendance/${courseId}`);
                const attendanceSnapshot = await get(attendanceRef);
                
                const tbody = document.getElementById('studentAttendanceBody');
                tbody.innerHTML = '';
                
                // Clear any existing summary sections more thoroughly
                const existingSummaries = document.querySelectorAll('.attendance-summary-section');
                existingSummaries.forEach(summary => {
                    summary.remove();
                });

                if (attendanceSnapshot.exists()) {
                    const attendanceData = attendanceSnapshot.val();
                    const studentAttendance = [];

                    for (const [date, dateData] of Object.entries(attendanceData)) {
                        if (dateData[currentStudentId]) {
                            studentAttendance.push({
                                date: date,
                                ...dateData[currentStudentId]
                            });
                        }
                    }

                    // Sort by date (newest first)
                    studentAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));

                    // Calculate statistics
                    const stats = {
                        present: 0,
                        late: 0,
                        sick: 0,
                        business: 0,
                        permission: 0,
                        absent: 0
                    };

                    studentAttendance.forEach(record => {
                        if (stats.hasOwnProperty(record.status)) {
                            stats[record.status]++;
                        }
                    });

                    const totalDays = studentAttendance.length;
                    const attendanceRate = totalDays > 0 ? ((stats.present + stats.late) / totalDays * 100).toFixed(1) : 0;

                    // Add summary section above the student info
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'mb-8 mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 attendance-summary-section';
                    summaryDiv.innerHTML = `
                        <div class="bg-gradient-to-br from-blue-800 via-blue-900 to-indigo-900 rounded-2xl p-8 shadow-xl">
                            <div class="text-center mb-8">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-white bg-opacity-20 rounded-full mb-4">
                                    <i class="fas fa-chart-pie text-2xl text-white"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2">สรุปผลการเข้าเรียน</h3>
                                <p class="text-blue-100">ภาพรวมการเข้าเรียนของคุณ</p>
                            </div>
                            
                            <!-- Student Information -->
                            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 mb-8 border border-white border-opacity-20">
                                <div class="text-center">
                                    <div class="inline-flex items-center justify-center w-12 h-12 bg-white bg-opacity-20 rounded-full mb-4">
                                        <i class="fas fa-user-graduate text-xl text-white"></i>
                                    </div>
                                    <h4 class="text-xl font-bold text-white mb-4">ข้อมูลนักเรียน</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                                        <div class="bg-white bg-opacity-10 rounded-lg p-4">
                                            <div class="text-blue-100 text-sm font-medium mb-1">ชื่อ-นามสกุล</div>
                                            <div class="text-white font-semibold">${studentData.prefix}${studentData.firstName} ${studentData.lastName}</div>
                                        </div>
                                        <div class="bg-white bg-opacity-10 rounded-lg p-4">
                                            <div class="text-blue-100 text-sm font-medium mb-1">รหัสนักเรียน</div>
                                            <div class="text-white font-semibold">${currentStudentId}</div>
                                        </div>
                                        <div class="bg-white bg-opacity-10 rounded-lg p-4">
                                            <div class="text-blue-100 text-sm font-medium mb-1">วิชา</div>
                                            <div class="text-white font-semibold">${courseData.name}</div>
                                        </div>
                                        <div class="bg-white bg-opacity-10 rounded-lg p-4">
                                            <div class="text-blue-100 text-sm font-medium mb-1">รหัสห้องเรียน</div>
                                            <div class="text-white font-semibold">${courseData.code}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Stats -->
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center border border-white border-opacity-20">
                                    <div class="text-3xl font-bold text-white mb-2">${totalDays}</div>
                                    <div class="text-blue-100 text-sm font-medium">วันทั้งหมด</div>
                                    <div class="mt-2">
                                        <i class="fas fa-calendar-alt text-blue-200"></i>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center border border-white border-opacity-20">
                                    <div class="text-3xl font-bold text-white mb-2">${attendanceRate}%</div>
                                    <div class="text-blue-100 text-sm font-medium">อัตราการเข้าเรียน</div>
                                    <div class="mt-2">
                                        <i class="fas fa-percentage text-blue-200"></i>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center border border-white border-opacity-20">
                                    <div class="text-3xl font-bold text-green-300 mb-2">${stats.present}</div>
                                    <div class="text-blue-100 text-sm font-medium">วันที่มาเรียน</div>
                                    <div class="mt-2">
                                        <i class="fas fa-check-circle text-green-300"></i>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 text-center border border-white border-opacity-20">
                                    <div class="text-3xl font-bold text-red-300 mb-2">${stats.absent}</div>
                                    <div class="text-blue-100 text-sm font-medium">วันที่ขาดเรียน</div>
                                    <div class="mt-2">
                                        <i class="fas fa-times-circle text-red-300"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailed Stats -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl p-4 text-white shadow-lg transform hover:scale-105 transition-transform duration-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="text-2xl font-bold">${stats.late}</div>
                                            <div class="text-yellow-100 text-sm font-medium">วันที่มาสาย</div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                                            <i class="fas fa-clock text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl p-4 text-white shadow-lg transform hover:scale-105 transition-transform duration-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="text-2xl font-bold">${stats.sick}</div>
                                            <div class="text-orange-100 text-sm font-medium">วันที่ลาป่วย</div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                                            <i class="fas fa-thermometer-half text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white shadow-lg transform hover:scale-105 transition-transform duration-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="text-2xl font-bold">${stats.business}</div>
                                            <div class="text-blue-100 text-sm font-medium">วันที่ลากิจ</div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                                            <i class="fas fa-briefcase text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-4 text-white shadow-lg transform hover:scale-105 transition-transform duration-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="text-2xl font-bold">${stats.permission}</div>
                                            <div class="text-purple-100 text-sm font-medium">วันที่ขอเวลาเรียน</div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                                            <i class="fas fa-hand-paper text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mt-8 bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 border border-white border-opacity-20">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-white font-medium">ความสม่ำเสมอในการเข้าเรียน</span>
                                    <span class="text-white font-bold">${attendanceRate}%</span>
                                </div>
                                <div class="w-full bg-white bg-opacity-20 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-green-400 to-green-500 h-3 rounded-full transition-all duration-1000 ease-out" style="width: ${attendanceRate}%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-blue-100 mt-2">
                                    <span>0%</span>
                                    <span>50%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    `;

                    // Insert summary before the student info section
                    const studentInfoDiv = document.getElementById('studentInfo').parentNode;
                    studentInfoDiv.parentNode.insertBefore(summaryDiv, studentInfoDiv);

                    studentAttendance.forEach(record => {
                        const row = document.createElement('tr');
                        const statusInfo = statusConfig[record.status] || statusConfig.absent;
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(record.date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full text-white ${statusInfo.color}">
                                    ${statusInfo.label}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.remark || '-'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูลการเข้าเรียน</td></tr>';
                }

                Swal.close();
                showPage('studentAttendance');
            } catch (error) {
                Swal.close();
                alert('เกิดข้อผิดพลาด: ' + error.message);
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                alert('ออกจากระบบไม่สำเร็จ: ' + error.message);
            }
        }

        function showPage(page) {
            const pages = [loginPage, classListPage, attendancePage, summaryPage, studentCourseSelectionPage, studentAttendancePage];
            pages.forEach(p => p.classList.add('hidden'));

            switch (page) {
                case 'login':
                    loginPage.classList.remove('hidden');
                    break;
                case 'classList':
                    classListPage.classList.remove('hidden');
                    break;
                case 'attendance':
                    attendancePage.classList.remove('hidden');
                    break;
                case 'summary':
                    summaryPage.classList.remove('hidden');
                    break;
                case 'studentCourseSelection':
                    studentCourseSelectionPage.classList.remove('hidden');
                    break;
                case 'studentAttendance':
                    studentAttendancePage.classList.remove('hidden');
                    break;
            }
        }

        async function loadClasses() {
            if (!currentUser) return;

            const coursesRef = ref(database, 'courses');
            const snapshot = await get(coursesRef);
            const classList = document.getElementById('classList');
            classList.innerHTML = '';

            if (snapshot.exists()) {
                const courses = snapshot.val();
                const userCourses = Object.entries(courses).filter(([id, course]) => 
                    course.teacherId === currentUser.uid && !course.archived
                );
                
                userCourses.forEach(([courseId, course], index) => {
                    const gradientClass = `gradient-bg-${(index % 6) + 1}`;
                    const card = document.createElement('div');
                    card.className = `${gradientClass} rounded-lg shadow-md hover:shadow-lg transition-all duration-300 text-white p-6 relative group`;
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <i class="fas fa-chalkboard-teacher text-2xl opacity-80"></i>
                            <span class="text-sm opacity-80">${course.code}</span>
                        </div>
                        <h3 class="text-xl font-bold mb-2">${course.name}</h3>
                        <p class="text-sm opacity-90 mb-4">คลิกเพื่อเข้าสู่ห้องเรียน</p>
                        
                        <!-- Action buttons -->
                        <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex space-x-2 z-10">
                            <button class="archive-btn bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-2 transition-all duration-200" 
                                    title="จัดเก็บห้องเรียน"
                                    data-course-id="${courseId}" 
                                    data-course-name="${course.name}">
                                <i class="fas fa-archive text-sm"></i>
                            </button>
                            <button class="delete-btn bg-red-500 bg-opacity-80 hover:bg-opacity-100 rounded-full p-2 transition-all duration-200" 
                                    title="ลบห้องเรียน"
                                    data-course-id="${courseId}" 
                                    data-course-name="${course.name}">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                        
                        <!-- Click area for entering class -->
                        <div class="absolute inset-0 cursor-pointer enter-class-btn" 
                             data-course-id="${courseId}" 
                             data-course='${JSON.stringify(course)}'></div>
                    `;
                    classList.appendChild(card);
                });

                // Add event listeners for the new buttons
                document.querySelectorAll('.archive-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const courseId = e.currentTarget.dataset.courseId;
                        const courseName = e.currentTarget.dataset.courseName;
                        archiveCourse(courseId, courseName);
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const courseId = e.currentTarget.dataset.courseId;
                        const courseName = e.currentTarget.dataset.courseName;
                        deleteCourse(courseId, courseName);
                    });
                });

                document.querySelectorAll('.enter-class-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const courseId = e.currentTarget.dataset.courseId;
                        const course = JSON.parse(e.currentTarget.dataset.course);
                        enterClass(courseId, course);
                    });
                });
            }

            if (classList.children.length === 0) {
                classList.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12">ยังไม่มีห้องเรียน กดปุ่ม "สร้างห้องเรียน" เพื่อเริ่มต้น</div>';
            }
        }

        async function handleCreateClass(e) {
            e.preventDefault();
            const className = document.getElementById('className').value.trim();
            const studentListText = document.getElementById('studentList').value.trim();

            if (!className) {
                alert('กรุณากรอกชื่อวิชา-ห้อง');
                return;
            }

            // Show progress overlay
            showProgress();
            
            try {
                // Step 1: Generate course data
                updateProgress(20, 'กำลังสร้างข้อมูลห้องเรียน...');
                await new Promise(resolve => setTimeout(resolve, 500));

                const courseRef = push(ref(database, 'courses'));
                const courseId = courseRef.key;
                const courseCode = generateCourseCode();

                // Step 2: Save course
                updateProgress(40, 'กำลังบันทึกข้อมูลห้องเรียน...');
                await set(courseRef, {
                    name: className,
                    code: courseCode,
                    teacherId: currentUser.uid,
                    createdAt: new Date().toISOString()
                });

                // Step 3: Process student list
                updateProgress(60, 'กำลังประมวลผลรายชื่อนักเรียน...');
                await new Promise(resolve => setTimeout(resolve, 300));

                if (studentListText) {
                    const lines = studentListText.split('\n').filter(line => line.trim());
                    const studentsRef = ref(database, `students/${courseId}`);
                    const studentsData = {};

                    lines.forEach((line, index) => {
                        const parts = line.split('\t').map(part => part.trim());
                        if (parts.length >= 5) {
                            // Format: เลขที่[Tab]รหัสนักเรียน[Tab]คำนำหน้า[Tab]ชื่อ[Tab]สกุล
                            const studentNumber = parts[0];
                            const studentId = parts[1];
                            studentsData[studentId] = {
                                number: studentNumber,
                                prefix: parts[2],
                                firstName: parts[3],
                                lastName: parts[4]
                            };
                        } else if (parts.length >= 3) {
                            // Fallback to old format: คำนำหน้า[Tab]ชื่อ[Tab]สกุล
                            const studentId = `STD${String(index + 1).padStart(3, '0')}`;
                            studentsData[studentId] = {
                                number: String(index + 1),
                                prefix: parts[0],
                                firstName: parts[1],
                                lastName: parts[2]
                            };
                        }
                    });

                    if (Object.keys(studentsData).length > 0) {
                        updateProgress(80, 'กำลังบันทึกรายชื่อนักเรียน...');
                        await set(studentsRef, studentsData);
                    }
                }

                // Step 4: Complete
                updateProgress(100, 'สร้างห้องเรียนสำเร็จ!');
                await new Promise(resolve => setTimeout(resolve, 500));

                // Hide progress and close modal
                hideProgress();
                createClassModal.classList.add('hidden');
                createClassModal.classList.remove('flex');
                document.getElementById('createClassForm').reset();
                
                // Refresh class list
                await loadClasses();
                
                alert(`สร้างห้องเรียนสำเร็จ!\nรหัสห้องเรียน: ${courseCode}`);
                
            } catch (error) {
                console.error('Error creating class:', error);
                hideProgress();
                alert('สร้างห้องเรียนไม่สำเร็จ: ' + error.message);
            }
        }

        function showProgress() {
            const overlay = document.getElementById('progressOverlay');
            overlay.classList.remove('hidden');
            updateProgress(0, 'เริ่มต้นการสร้าง...');
        }

        function hideProgress() {
            const overlay = document.getElementById('progressOverlay');
            overlay.classList.add('hidden');
        }

        function updateProgress(percentage, message) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = percentage + '%';
            progressText.textContent = message;
        }

        function generateCourseCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        async function enterClass(courseId, course) {
            currentCourseId = courseId;
            document.getElementById('currentClassName').textContent = course.name;
            
            // Set header gradient based on course index
            const coursesRef = ref(database, 'courses');
            const coursesSnapshot = await get(coursesRef);
            let courseIndex = 0;
            
            if (coursesSnapshot.exists()) {
                const courses = coursesSnapshot.val();
                const userCourses = Object.entries(courses)
                    .filter(([id, c]) => c.teacherId === currentUser.uid && !c.archived)
                    .sort(([a], [b]) => a.localeCompare(b));
                
                courseIndex = userCourses.findIndex(([id]) => id === courseId);
                if (courseIndex === -1) courseIndex = 0;
            }
            
            // Apply gradient class to header
            const headerElement = document.querySelector('#attendancePage .bg-gradient-to-br');
            if (headerElement) {
                // Remove all existing gradient classes
                headerElement.classList.remove('gradient-bg-1', 'gradient-bg-2', 'gradient-bg-3', 'gradient-bg-4', 'gradient-bg-5', 'gradient-bg-6');
                headerElement.classList.remove('from-yellow-400', 'via-orange-500', 'to-orange-600');
                
                // Add new gradient class
                const gradientClass = `gradient-bg-${(courseIndex % 6) + 1}`;
                headerElement.classList.add(gradientClass);
            }
            
            // Load students
            const studentsRef = ref(database, `students/${courseId}`);
            const studentsSnapshot = await get(studentsRef);
            
            if (studentsSnapshot.exists()) {
                currentStudents = studentsSnapshot.val();
                renderStudentTable();
                loadAttendanceForDate();
            } else {
                currentStudents = {};
                document.getElementById('studentTableBody').innerHTML = 
                    '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">ยังไม่มีรายชื่อนักเรียน</td></tr>';
            }

            showPage('attendance');
        }

        function renderStudentTable() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';

            Object.entries(currentStudents).forEach(([studentId, student]) => {
                const row = document.createElement('tr');
                row.id = `row-${studentId}`;
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${student.number ? student.number + '. ' : ''}${student.prefix}${student.firstName} ${student.lastName}</div>
                        <div class="text-sm text-gray-500">รหัส: ${studentId}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex flex-wrap gap-1">
                            ${Object.entries(statusConfig).map(([status, config]) => 
                                `<button class="status-btn px-3 py-1 text-xs font-medium text-white rounded-md ${config.color} hover:opacity-80 transition-opacity" 
                                         data-student="${studentId}" data-status="${status}">${config.label}</button>`
                            ).join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" class="remark-input w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" 
                               data-student="${studentId}" placeholder="หมายเหตุ">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-red-600 hover:text-red-800 opacity-50 cursor-not-allowed" disabled>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add event listeners for status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const studentId = e.target.dataset.student;
                    const status = e.target.dataset.status;
                    setStudentStatus(studentId, status);
                });
            });
        }

        function setStudentStatus(studentId, status) {
            const row = document.getElementById(`row-${studentId}`);
            const statusInfo = statusConfig[status];
            
            // Remove all row classes
            Object.values(statusConfig).forEach(config => {
                row.classList.remove(config.rowClass);
            });
            
            // Add new row class
            row.classList.add(statusInfo.rowClass);
            
            // Update button styles
            const statusButtons = row.querySelectorAll('.status-btn');
            statusButtons.forEach(btn => {
                const btnStatus = btn.dataset.status;
                const btnConfig = statusConfig[btnStatus];
                
                if (btnStatus === status) {
                    // Selected button - show original color
                    btn.className = `status-btn px-3 py-1 text-xs font-medium text-white rounded-md ${btnConfig.color} hover:opacity-80 transition-opacity`;
                } else {
                    // Unselected buttons - show gray but still clickable
                    btn.className = `status-btn px-3 py-1 text-xs font-medium text-white rounded-md bg-gray-400 hover:bg-gray-500 transition-colors`;
                }
            });
            
            // Store in attendance data
            if (!attendanceData[studentId]) {
                attendanceData[studentId] = {};
            }
            attendanceData[studentId].status = status;
        }

        function bulkSetStatus(status) {
            Object.keys(currentStudents).forEach(studentId => {
                setStudentStatus(studentId, status);
            });
        }

        async function loadAttendanceForDate() {
            const date = document.getElementById('attendanceDate').value;
            if (!date || !currentCourseId) return;

            const attendanceRef = ref(database, `attendance/${currentCourseId}/${date}`);
            const snapshot = await get(attendanceRef);
            
            // Reset attendance data
            attendanceData = {};
            
            // Clear all row styling and reset buttons
            Object.keys(currentStudents).forEach(studentId => {
                const row = document.getElementById(`row-${studentId}`);
                if (row) {
                    Object.values(statusConfig).forEach(config => {
                        row.classList.remove(config.rowClass);
                    });
                    
                    // Reset all buttons to original colors
                    const statusButtons = row.querySelectorAll('.status-btn');
                    statusButtons.forEach(btn => {
                        const btnStatus = btn.dataset.status;
                        const btnConfig = statusConfig[btnStatus];
                        btn.className = `status-btn px-3 py-1 text-xs font-medium text-white rounded-md ${btnConfig.color} hover:opacity-80 transition-opacity`;
                    });
                }
            });

            if (snapshot.exists()) {
                const dayAttendance = snapshot.val();
                Object.entries(dayAttendance).forEach(([studentId, data]) => {
                    attendanceData[studentId] = data;
                    
                    // Update UI
                    const row = document.getElementById(`row-${studentId}`);
                    if (row) {
                        const statusInfo = statusConfig[data.status];
                        if (statusInfo) {
                            row.classList.add(statusInfo.rowClass);
                        }
                        
                        // Update button styles
                        const statusButtons = row.querySelectorAll('.status-btn');
                        statusButtons.forEach(btn => {
                            const btnStatus = btn.dataset.status;
                            const btnConfig = statusConfig[btnStatus];
                            
                            if (btnStatus === data.status) {
                                // Selected button - show original color
                                btn.className = `status-btn px-3 py-1 text-xs font-medium text-white rounded-md ${btnConfig.color} hover:opacity-80 transition-opacity`;
                            } else {
                                // Unselected buttons - show gray but still clickable
                                btn.className = `status-btn px-3 py-1 text-xs font-medium text-white rounded-md bg-gray-400 hover:bg-gray-500 transition-colors`;
                            }
                        });
                        
                        // Set remark
                        const remarkInput = row.querySelector('.remark-input');
                        if (remarkInput) {
                            remarkInput.value = data.remark || '';
                        }
                    }
                });
            }
        }

        async function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!date || !currentCourseId) return;

            // Collect remarks
            document.querySelectorAll('.remark-input').forEach(input => {
                const studentId = input.dataset.student;
                if (attendanceData[studentId]) {
                    attendanceData[studentId].remark = input.value.trim();
                }
            });

            try {
                const attendanceRef = ref(database, `attendance/${currentCourseId}/${date}`);
                await set(attendanceRef, attendanceData);
                
                // Get course name and format date
                const courseName = document.getElementById('currentClassName').textContent;
                const formattedDate = formatDate(date);
                
                // Count attendance statistics
                const stats = {
                    present: 0,
                    late: 0,
                    sick: 0,
                    business: 0,
                    permission: 0,
                    absent: 0
                };
                
                Object.values(attendanceData).forEach(record => {
                    if (stats.hasOwnProperty(record.status)) {
                        stats[record.status]++;
                    }
                });
                
                const totalStudents = Object.keys(currentStudents).length;
                const checkedStudents = Object.keys(attendanceData).length;
                
                // Calculate attendance rate
                const attendanceRate = totalStudents > 0 ? ((stats.present + stats.late) / totalStudents * 100).toFixed(1) : 0;
                
                // Show beautiful success popup
                await Swal.fire({
                    icon: 'success',
                    html: `
                        <div class="text-left space-y-4">
                            <!-- Header Section -->
                            <div class="text-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">การบันทึกเสร็จสมบูรณ์</h3>
                                <p class="text-gray-600">ข้อมูลการเช็คชื่อถูกบันทึกเรียบร้อยแล้ว</p>
                            </div>

                            <!-- Course Info Card -->
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white shadow-lg">
                                <div class="flex items-center mb-3">
                                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-book text-lg"></i>
                                    </div>
                                    <h4 class="font-bold text-lg">รายละเอียดการบันทึก</h4>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                        <div class="text-blue-100 text-xs font-medium">วิชา</div>
                                        <div class="font-semibold">${courseName}</div>
                                    </div>
                                    <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                        <div class="text-blue-100 text-xs font-medium">วันที่</div>
                                        <div class="font-semibold">${formattedDate}</div>
                                    </div>
                                    <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                        <div class="text-blue-100 text-xs font-medium">จำนวนนักเรียน</div>
                                        <div class="font-semibold">${totalStudents} คน</div>
                                    </div>
                                    <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                        <div class="text-blue-100 text-xs font-medium">เช็คชื่อแล้ว</div>
                                        <div class="font-semibold">${checkedStudents} คน</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${checkedStudents > 0 ? `
                            <!-- Statistics Card -->
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-200">
                                <div class="flex items-center mb-4">
                                    <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-chart-pie text-white"></i>
                                    </div>
                                    <h4 class="font-bold text-green-800 text-lg">สถิติการเข้าเรียน</h4>
                                </div>
                                
                                <!-- Attendance Rate -->
                                <div class="bg-white rounded-lg p-4 mb-4 shadow-sm">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-gray-700 font-medium">อัตราการเข้าเรียน</span>
                                        <span class="text-2xl font-bold text-green-600">${attendanceRate}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-gradient-to-r from-green-400 to-green-500 h-3 rounded-full transition-all duration-1000 ease-out" style="width: ${attendanceRate}%"></div>
                                    </div>
                                </div>
                                
                                <!-- Detailed Stats -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-3 text-white">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="text-2xl font-bold">${stats.present}</div>
                                                <div class="text-green-100 text-sm">มาเรียน</div>
                                            </div>
                                            <div class="bg-white bg-opacity-20 rounded-full p-2">
                                                <i class="fas fa-check text-lg"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg p-3 text-white">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="text-2xl font-bold">${stats.late}</div>
                                                <div class="text-yellow-100 text-sm">มาสาย</div>
                                            </div>
                                            <div class="bg-white bg-opacity-20 rounded-full p-2">
                                                <i class="fas fa-clock text-lg"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg p-3 text-white">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="text-2xl font-bold">${stats.sick}</div>
                                                <div class="text-orange-100 text-sm">ลาป่วย</div>
                                            </div>
                                            <div class="bg-white bg-opacity-20 rounded-full p-2">
                                                <i class="fas fa-thermometer-half text-lg"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-3 text-white">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="text-2xl font-bold">${stats.business}</div>
                                                <div class="text-blue-100 text-sm">ลากิจ</div>
                                            </div>
                                            <div class="bg-white bg-opacity-20 rounded-full p-2">
                                                <i class="fas fa-briefcase text-lg"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-3 text-white">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="text-2xl font-bold">${stats.permission}</div>
                                                <div class="text-purple-100 text-sm">ขอลาเรียน</div>
                                            </div>
                                            <div class="bg-white bg-opacity-20 rounded-full p-2">
                                                <i class="fas fa-hand-paper text-lg"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-r from-gray-500 to-gray-600 rounded-lg p-3 text-white">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="text-2xl font-bold">${stats.absent}</div>
                                                <div class="text-gray-100 text-sm">ขาดเรียน</div>
                                            </div>
                                            <div class="bg-white bg-opacity-20 rounded-full p-2">
                                                <i class="fas fa-times text-lg"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ` : `
                            <!-- No Data Message -->
                            <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-200">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-info-circle text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-yellow-800">ยังไม่มีการเช็คชื่อ</h4>
                                        <p class="text-yellow-700 text-sm">ข้อมูลถูกบันทึกแล้ว แต่ยังไม่มีนักเรียนที่ถูกเช็คชื่อ</p>
                                    </div>
                                </div>
                            </div>
                            `}
                            
                            <!-- Footer -->
                            <div class="text-center pt-4 border-t border-gray-200">
                                <div class="flex items-center justify-center text-sm text-gray-500">
                                    <i class="fas fa-clock mr-2"></i>
                                    <span>บันทึกเมื่อ: ${new Date().toLocaleString('th-TH')}</span>
                                </div>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'เรียบร้อย',
                    confirmButtonColor: '#10b981',
                    width: '650px',
                    padding: '2rem',
                    showClass: {
                        popup: 'animate__animated animate__bounceIn'
                    },
                    hideClass: {
                        popup: 'animate__animated animate__fadeOutUp'
                    },
                    customClass: {
                        popup: 'rounded-2xl shadow-2xl',
                        title: 'text-2xl font-bold',
                        confirmButton: 'rounded-xl px-8 py-3 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200'
                    },
                    backdrop: `
                        rgba(0,0,0,0.6)
                        url("data:image/svg+xml,%3csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3e%3cg fill='none' fill-rule='evenodd'%3e%3cg fill='%23ffffff' fill-opacity='0.1'%3e%3ccircle cx='30' cy='30' r='4'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e")
                        center/400px
                    `
                });
                
            } catch (error) {
                // Show error popup
                await Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด!',
                    text: 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message,
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        async function showSummaryPage() {
            if (!currentCourseId) return;

            document.getElementById('summaryClassName').textContent = document.getElementById('currentClassName').textContent;

            // Set header gradient to match attendance page
            const attendanceHeader = document.querySelector('#attendancePage .bg-gradient-to-br');
            const summaryHeader = document.querySelector('#summaryPage .bg-gradient-to-br');
            
            if (attendanceHeader && summaryHeader) {
                // Copy gradient class from attendance page
                const gradientClasses = ['gradient-bg-1', 'gradient-bg-2', 'gradient-bg-3', 'gradient-bg-4', 'gradient-bg-5', 'gradient-bg-6'];
                
                // Remove existing gradient classes from summary header
                summaryHeader.classList.remove(...gradientClasses);
                summaryHeader.classList.remove('from-yellow-400', 'via-orange-500', 'to-orange-600');
                
                // Find and apply the current gradient class
                const currentGradient = gradientClasses.find(cls => attendanceHeader.classList.contains(cls));
                if (currentGradient) {
                    summaryHeader.classList.add(currentGradient);
                }
            }

            // Load all attendance data for this course
            const attendanceRef = ref(database, `attendance/${currentCourseId}`);
            const snapshot = await get(attendanceRef);

            const header = document.getElementById('summaryTableHeader');
            const tbody = document.getElementById('summaryTableBody');
            
            // Clear existing content
            header.innerHTML = '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">รายชื่อ</th>';
            tbody.innerHTML = '';

            if (snapshot.exists()) {
                const allAttendance = snapshot.val();
                const dates = Object.keys(allAttendance).sort();

                // Add date headers
                dates.forEach(date => {
                    const th = document.createElement('th');
                    th.className = 'px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-24';
                    th.textContent = formatDateShort(date);
                    header.appendChild(th);
                });

                // Add student rows
                Object.entries(currentStudents).forEach(([studentId, student]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white">
                            ${student.number ? student.number + '. ' : ''}${student.prefix}${student.firstName} ${student.lastName}
                        </td>
                        ${dates.map(date => {
                            const attendance = allAttendance[date]?.[studentId];
                            if (attendance) {
                                const statusInfo = statusConfig[attendance.status];
                                return `<td class="px-3 py-4 text-center">
                                    <span class="inline-block w-6 h-6 rounded-full ${statusInfo.color} text-white text-xs flex items-center justify-center font-semibold" title="${statusInfo.label}${attendance.remark ? ' - ' + attendance.remark : ''}">${statusInfo.symbol}</span>
                                </td>`;
                            } else {
                                return '<td class="px-3 py-4 text-center"><span class="inline-block w-6 h-6 rounded-full bg-gray-200 text-gray-500 text-xs flex items-center justify-center" title="ไม่มีข้อมูล">-</span></td>';
                            }
                        }).join('')}
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="100%" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูลการเช็คชื่อ</td></tr>';
            }

            showPage('summary');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                month: 'short',
                day: 'numeric'
            });
        }

        // Student Management Functions
        let studentsToDelete = new Set();

        function openManageStudentsModal() {
            const modal = document.getElementById('manageStudentsModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            studentsToDelete.clear();
            renderManageStudentsTable();
        }

        function closeManageStudentsModal() {
            const modal = document.getElementById('manageStudentsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('addStudentForm').reset();
        }

        function renderManageStudentsTable() {
            const tbody = document.getElementById('manageStudentsTableBody');
            const studentCountElement = document.getElementById('studentCount');
            tbody.innerHTML = '';

            const sortedStudents = Object.entries(currentStudents).sort(([,a], [,b]) => {
                const numA = parseInt(a.number) || 999;
                const numB = parseInt(b.number) || 999;
                return numA - numB;
            });

            // Update student count
            const totalStudents = sortedStudents.length;
            const deletedCount = studentsToDelete.size;
            const activeCount = totalStudents - deletedCount;
            studentCountElement.textContent = `${activeCount} คน${deletedCount > 0 ? ` (จะลบ ${deletedCount} คน)` : ''}`;

            sortedStudents.forEach(([studentId, student], index) => {
                const row = document.createElement('tr');
                const isMarkedForDeletion = studentsToDelete.has(studentId);
                
                row.className = `hover:bg-orange-50 transition-colors duration-200 ${isMarkedForDeletion ? 'bg-red-50 border-l-4 border-red-400' : ''}`;
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex justify-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-orange-400 to-yellow-400 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md ${isMarkedForDeletion ? 'opacity-50' : ''}">
                                ${student.number || (index + 1)}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-id-card text-blue-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold ${isMarkedForDeletion ? 'text-red-500 line-through' : 'text-gray-900'}">${studentId}</div>
                                <div class="text-xs text-gray-500">รหัสนักเรียน</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-user text-green-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="text-sm font-semibold ${isMarkedForDeletion ? 'text-red-500 line-through' : 'text-gray-900'}">${student.prefix}${student.firstName} ${student.lastName}</div>
                                <div class="text-xs text-gray-500">คำนำหน้า: ${student.prefix} | ชื่อ: ${student.firstName} | สกุล: ${student.lastName}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex justify-center space-x-2">
                            <button class="bg-blue-100 hover:bg-blue-200 text-blue-600 hover:text-blue-800 p-2 rounded-lg transition-all duration-200 ${isMarkedForDeletion ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105'}" 
                                    onclick="editStudent('${studentId}')" 
                                    ${isMarkedForDeletion ? 'disabled' : ''}
                                    title="แก้ไขข้อมูล">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button class="${isMarkedForDeletion ? 'bg-green-100 hover:bg-green-200 text-green-600 hover:text-green-800' : 'bg-red-100 hover:bg-red-200 text-red-600 hover:text-red-800'} p-2 rounded-lg transition-all duration-200 hover:scale-105" 
                                    onclick="toggleDeleteStudent('${studentId}')"
                                    title="${isMarkedForDeletion ? 'ยกเลิกการลบ' : 'ลบนักเรียน'}">
                                <i class="fas ${isMarkedForDeletion ? 'fa-undo' : 'fa-trash'} text-sm"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (sortedStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-users text-2xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-600 mb-2">ยังไม่มีนักเรียนในห้องเรียนนี้</h3>
                                <p class="text-sm text-gray-500">เริ่มต้นโดยการเพิ่มนักเรียนคนแรกด้านบน</p>
                            </div>
                        </td>
                    </tr>
                `;
                studentCountElement.textContent = '0 คน';
            }
        }

        async function handleAddStudent(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('newStudentId').value.trim();
            const number = document.getElementById('newStudentNumber').value.trim();
            const prefix = document.getElementById('newStudentPrefix').value;
            const firstName = document.getElementById('newStudentFirstName').value.trim();
            const lastName = document.getElementById('newStudentLastName').value.trim();

            // Check if student ID already exists
            if (currentStudents[studentId]) {
                alert('รหัสนักเรียนนี้มีอยู่แล้ว กรุณาใช้รหัสอื่น');
                return;
            }

            // Add to current students object
            currentStudents[studentId] = {
                number: number,
                prefix: prefix,
                firstName: firstName,
                lastName: lastName
            };

            // Clear form
            document.getElementById('addStudentForm').reset();
            
            // Re-render table
            renderManageStudentsTable();
            
            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'เพิ่มนักเรียนสำเร็จ!',
                text: `เพิ่ม ${prefix}${firstName} ${lastName} แล้ว`,
                timer: 2000,
                showConfirmButton: false
            });
        }

        function editStudent(studentId) {
            const student = currentStudents[studentId];
            if (!student) return;

            // Fill edit form
            document.getElementById('editStudentOriginalId').value = studentId;
            document.getElementById('editStudentNumber').value = student.number || '';
            document.getElementById('editStudentId').value = studentId;
            document.getElementById('editStudentPrefix').value = student.prefix;
            document.getElementById('editStudentFirstName').value = student.firstName;
            document.getElementById('editStudentLastName').value = student.lastName;

            // Show modal
            const modal = document.getElementById('editStudentModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeEditStudentModal() {
            const modal = document.getElementById('editStudentModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('editStudentForm').reset();
        }

        async function handleEditStudent(e) {
            e.preventDefault();
            
            const originalId = document.getElementById('editStudentOriginalId').value;
            const newId = document.getElementById('editStudentId').value.trim();
            const number = document.getElementById('editStudentNumber').value.trim();
            const prefix = document.getElementById('editStudentPrefix').value;
            const firstName = document.getElementById('editStudentFirstName').value.trim();
            const lastName = document.getElementById('editStudentLastName').value.trim();

            // Check if new ID conflicts with existing student (except original)
            if (newId !== originalId && currentStudents[newId]) {
                alert('รหัสนักเรียนนี้มีอยู่แล้ว กรุณาใช้รหัสอื่น');
                return;
            }

            // Update student data
            const updatedStudent = {
                number: number,
                prefix: prefix,
                firstName: firstName,
                lastName: lastName
            };

            // If ID changed, remove old entry and add new one
            if (newId !== originalId) {
                delete currentStudents[originalId];
                currentStudents[newId] = updatedStudent;
            } else {
                currentStudents[originalId] = updatedStudent;
            }

            // Close modal and refresh table
            closeEditStudentModal();
            renderManageStudentsTable();
            
            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'แก้ไขข้อมูลสำเร็จ!',
                text: `แก้ไขข้อมูล ${prefix}${firstName} ${lastName} แล้ว`,
                timer: 2000,
                showConfirmButton: false
            });
        }

        function toggleDeleteStudent(studentId) {
            if (studentsToDelete.has(studentId)) {
                studentsToDelete.delete(studentId);
            } else {
                studentsToDelete.add(studentId);
            }
            renderManageStudentsTable();
        }

        async function saveStudentChanges() {
            try {
                // Remove deleted students
                studentsToDelete.forEach(studentId => {
                    delete currentStudents[studentId];
                });

                // Save to database
                const studentsRef = ref(database, `students/${currentCourseId}`);
                await set(studentsRef, currentStudents);

                // Close modal
                closeManageStudentsModal();
                
                // Refresh attendance page
                renderStudentTable();
                loadAttendanceForDate();
                
                // Show success message
                const deletedCount = studentsToDelete.size;
                studentsToDelete.clear();
                
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกการเปลี่ยนแปลงสำเร็จ!',
                    text: deletedCount > 0 ? `ลบนักเรียน ${deletedCount} คน และบันทึกการแก้ไขแล้ว` : 'บันทึกการแก้ไขแล้ว',
                    timer: 2000,
                    showConfirmButton: false
                });
                
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด!',
                    text: 'ไม่สามารถบันทึกการเปลี่ยนแปลงได้: ' + error.message
                });
            }
        }

        async function editClassName() {
            const currentName = document.getElementById('currentClassName').textContent;
            
            const { value: newName } = await Swal.fire({
                html: `
                    <div class="text-left space-y-6">
                        <!-- Header Section -->
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-2xl mb-4 shadow-lg">
                                <i class="fas fa-edit text-2xl text-white"></i>
                            </div>
                            <h3 class="text-2xl font-bold bg-gradient-to-r from-orange-600 to-yellow-600 bg-clip-text text-transparent mb-2">แก้ไขชื่อวิชา</h3>
                            <p class="text-gray-600">ปรับปรุงชื่อวิชาให้เหมาะสมกับการเรียนการสอน</p>
                        </div>

                        <!-- Current Name Display -->
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
                            <div class="flex items-center mb-2">
                                <div class="w-8 h-8 bg-gray-500 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-book text-white text-sm"></i>
                                </div>
                                <span class="font-semibold text-gray-800">ชื่อวิชาปัจจุบัน</span>
                            </div>
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <p class="text-gray-800 font-medium">${currentName}</p>
                            </div>
                        </div>

                        <!-- Input Section -->
                        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl p-4 border border-orange-200">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-yellow-500 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-pencil-alt text-white text-sm"></i>
                                </div>
                                <span class="font-semibold text-orange-800">ชื่อวิชาใหม่</span>
                            </div>
                            <div class="relative">
                                <input type="text" id="newCourseName" class="w-full px-4 py-3 border-2 border-orange-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200 bg-white text-gray-800 font-medium" 
                                       placeholder="กรอกชื่อวิชาใหม่..." 
                                       value="${currentName}">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <i class="fas fa-keyboard text-orange-400"></i>
                                </div>
                            </div>
                            <p class="text-xs text-orange-600 mt-2 flex items-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                ตัวอย่าง: คณิตศาสตร์ ม.1/1, ภาษาไทย ป.6/2
                            </p>
                        </div>

                        <!-- Tips Section -->
                        <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                            <div class="flex items-center mb-2">
                                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-lightbulb text-white text-sm"></i>
                                </div>
                                <span class="font-semibold text-blue-800">คำแนะนำ</span>
                            </div>
                            <ul class="text-sm text-blue-700 space-y-1 list-disc list-inside">
                                <li>ใช้ชื่อที่สั้น กระชับ และเข้าใจง่าย</li>
                                <li>ระบุระดับชั้นและห้องเรียนให้ชัดเจน</li>
                                <li>หลีกเลี่ยงการใช้อักขระพิเศษ</li>
                            </ul>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-save mr-2"></i>บันทึกการเปลี่ยนแปลง',
                cancelButtonText: '<i class="fas fa-times mr-2"></i>ยกเลิก',
                confirmButtonColor: '#f59e0b',
                cancelButtonColor: '#6b7280',
                width: '600px',
                padding: '2rem',
                showClass: {
                    popup: 'animate__animated animate__fadeInDown'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOutUp'
                },
                customClass: {
                    popup: 'rounded-2xl shadow-2xl',
                    confirmButton: 'rounded-xl px-6 py-3 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200',
                    cancelButton: 'rounded-xl px-6 py-3 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200'
                },
                backdrop: `
                    rgba(0,0,0,0.6)
                    url("data:image/svg+xml,%3csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3e%3cg fill='none' fill-rule='evenodd'%3e%3cg fill='%23f59e0b' fill-opacity='0.1'%3e%3ccircle cx='30' cy='30' r='4'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e")
                    center/400px
                `,
                didOpen: () => {
                    // Focus on input and select all text
                    const input = document.getElementById('newCourseName');
                    input.focus();
                    input.select();
                    
                    // Add real-time validation
                    input.addEventListener('input', (e) => {
                        const value = e.target.value.trim();
                        const confirmButton = Swal.getConfirmButton();
                        
                        if (value && value !== currentName) {
                            confirmButton.disabled = false;
                            confirmButton.style.opacity = '1';
                            confirmButton.style.cursor = 'pointer';
                        } else {
                            confirmButton.disabled = true;
                            confirmButton.style.opacity = '0.6';
                            confirmButton.style.cursor = 'not-allowed';
                        }
                    });
                },
                preConfirm: () => {
                    const input = document.getElementById('newCourseName');
                    const value = input.value.trim();
                    
                    if (!value) {
                        Swal.showValidationMessage('กรุณากรอกชื่อวิชา');
                        return false;
                    }
                    
                    if (value === currentName) {
                        Swal.showValidationMessage('ชื่อวิชาใหม่ต้องแตกต่างจากเดิม');
                        return false;
                    }
                    
                    if (value.length > 100) {
                        Swal.showValidationMessage('ชื่อวิชาต้องไม่เกิน 100 ตัวอักษร');
                        return false;
                    }
                    
                    return value;
                }
            });

            if (newName && newName.trim() !== currentName) {
                try {
                    // Update in database
                    const courseRef = ref(database, `courses/${currentCourseId}/name`);
                    await set(courseRef, newName.trim());
                    
                    // Update UI
                    document.getElementById('currentClassName').textContent = newName.trim();
                    
                    // Show success message
                    await Swal.fire({
                        html: `
                            <div class="text-center space-y-4">
                                <!-- Success Icon -->
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-full mb-4 shadow-lg">
                                    <i class="fas fa-check text-3xl text-white"></i>
                                </div>
                                
                                <!-- Title -->
                                <h3 class="text-2xl font-bold text-green-600 mb-2">แก้ไขชื่อวิชาสำเร็จ!</h3>
                                
                                <!-- Before/After Comparison -->
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border border-green-200">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <!-- Before -->
                                        <div class="bg-white rounded-lg p-4 border border-gray-200">
                                            <div class="flex items-center mb-2">
                                                <div class="w-6 h-6 bg-gray-400 rounded-full flex items-center justify-center mr-2">
                                                    <i class="fas fa-arrow-left text-white text-xs"></i>
                                                </div>
                                                <span class="text-sm font-medium text-gray-600">ชื่อเดิม</span>
                                            </div>
                                            <p class="text-gray-800 font-medium text-sm">${currentName}</p>
                                        </div>
                                        
                                        <!-- After -->
                                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg p-4 border border-green-300">
                                            <div class="flex items-center mb-2">
                                                <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-2">
                                                    <i class="fas fa-arrow-right text-white text-xs"></i>
                                                </div>
                                                <span class="text-sm font-medium text-green-700">ชื่อใหม่</span>
                                            </div>
                                            <p class="text-green-800 font-bold text-sm">${newName.trim()}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Success Message -->
                                <div class="bg-green-100 rounded-lg p-4 border border-green-200">
                                    <div class="flex items-center justify-center">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-info-circle text-white text-sm"></i>
                                        </div>
                                        <div class="text-left">
                                            <p class="text-green-800 font-semibold text-sm">การเปลี่ยนแปลงมีผลทันที</p>
                                            <p class="text-green-600 text-xs">ชื่อวิชาใหม่จะแสดงในทุกส่วนของระบบ</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Footer -->
                                <div class="text-center pt-2">
                                    <div class="flex items-center justify-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>อัปเดตเมื่อ: ${new Date().toLocaleString('th-TH')}</span>
                                    </div>
                                </div>
                            </div>
                        `,
                        confirmButtonText: '<i class="fas fa-thumbs-up mr-2"></i>เยี่ยมเลย!',
                        confirmButtonColor: '#10b981',
                        width: '550px',
                        padding: '2rem',
                        showClass: {
                            popup: 'animate__animated animate__bounceIn'
                        },
                        hideClass: {
                            popup: 'animate__animated animate__fadeOutUp'
                        },
                        customClass: {
                            popup: 'rounded-2xl shadow-2xl',
                            confirmButton: 'rounded-xl px-8 py-3 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200'
                        },
                        backdrop: `
                            rgba(0,0,0,0.6)
                            url("data:image/svg+xml,%3csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3e%3cg fill='none' fill-rule='evenodd'%3e%3cg fill='%2310b981' fill-opacity='0.1'%3e%3ccircle cx='30' cy='30' r='4'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e")
                            center/400px
                        `
                    });
                    
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด!',
                        text: 'ไม่สามารถแก้ไขชื่อวิชาได้: ' + error.message
                    });
                }
            }
        }

        // Export Functions
        async function exportToGoogleSheets() {
            if (!currentCourseId) return;

            try {
                // Show loading with progress
                Swal.fire({
                    html: `
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                                <i class="fab fa-google text-2xl text-green-600 animate-pulse"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">กำลังสร้าง Google Sheets</h3>
                            <p class="text-gray-600 mb-4">กรุณารอสักครู่...</p>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="exportProgress" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="exportStatus" class="text-sm text-gray-500 mt-2">เริ่มต้นการประมวลผล...</p>
                        </div>
                    `,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    width: '400px'
                });

                // Update progress
                const updateProgress = (percent, status) => {
                    const progressBar = document.getElementById('exportProgress');
                    const statusText = document.getElementById('exportStatus');
                    if (progressBar) progressBar.style.width = percent + '%';
                    if (statusText) statusText.textContent = status;
                };

                updateProgress(20, 'กำลังโหลดข้อมูลการเช็คชื่อ...');

                // Get attendance data
                const attendanceRef = ref(database, `attendance/${currentCourseId}`);
                const snapshot = await get(attendanceRef);
                
                if (!snapshot.exists()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'ไม่มีข้อมูล',
                        html: `
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 rounded-full mb-4">
                                    <i class="fas fa-exclamation-triangle text-2xl text-yellow-600"></i>
                                </div>
                                <p class="text-gray-600">ไม่มีข้อมูลการเช็คชื่อสำหรับการ Export Google Sheets</p>
                                <div class="bg-blue-50 rounded-lg p-4 mt-4">
                                    <p class="text-sm text-blue-700">💡 กรุณาทำการเช็คชื่อก่อนแล้วจึงลอง Export อีกครั้ง</p>
                                </div>
                            </div>
                        `,
                        confirmButtonText: 'เข้าใจแล้ว',
                        confirmButtonColor: '#f59e0b'
                    });
                    return;
                }

                updateProgress(40, 'กำลังประมวลผลข้อมูล...');

                const allAttendance = snapshot.val();
                const dates = Object.keys(allAttendance).sort();
                const className = document.getElementById('summaryClassName').textContent || 'ห้องเรียน';

                updateProgress(60, 'กำลังสร้างตารางข้อมูล...');

                // Prepare data for Google Sheets
                const sheetsData = [];
                
                // Title rows
                sheetsData.push([`สรุปผลการเรียน: ${className}`]);
                sheetsData.push([`วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                })}`]);
                sheetsData.push([`จำนวนนักเรียน: ${Object.keys(currentStudents).length} คน`]);
                sheetsData.push([`จำนวนวันที่มีข้อมูล: ${dates.length} วัน`]);
                sheetsData.push([]); // Empty row
                
                // Legend
                sheetsData.push(['สัญลักษณ์การเข้าเรียน:']);
                sheetsData.push(['1 = มาเรียน', 'ส = มาสาย', 'ป = ลาป่วย', 'ก = ลากิจ', 'ว = ขอเวลาเรียน', 'ข = ขาดเรียน', '- = ไม่มีข้อมูล']);
                sheetsData.push([]); // Empty row
                
                // Header row
                const headerRow = ['ลำดับ', 'รหัสนักเรียน', 'ชื่อ-สกุล', 'รวมมาเรียน', 'รวมมาสาย', 'รวมลาป่วย', 'รวมลากิจ', 'รวมขอเวลา', 'รวมขาดเรียน', 'เปอร์เซ็นต์เข้าเรียน', ...dates.map(date => formatDateShort(date))];
                sheetsData.push(headerRow);

                updateProgress(80, 'กำลังคำนวณสถิติ...');

                // Student rows with statistics
                const sortedStudents = Object.entries(currentStudents).sort(([,a], [,b]) => {
                    const numA = parseInt(a.number) || 999;
                    const numB = parseInt(b.number) || 999;
                    return numA - numB;
                });

                sortedStudents.forEach(([studentId, student]) => {
                    // Calculate statistics for each student
                    const stats = {
                        present: 0,
                        late: 0,
                        sick: 0,
                        business: 0,
                        permission: 0,
                        absent: 0
                    };

                    dates.forEach(date => {
                        const attendance = allAttendance[date]?.[studentId];
                        if (attendance && stats.hasOwnProperty(attendance.status)) {
                            stats[attendance.status]++;
                        }
                    });

                    const totalDays = dates.length;
                    const attendanceDays = stats.present + stats.late;
                    const attendanceRate = totalDays > 0 ? ((attendanceDays / totalDays) * 100).toFixed(1) + '%' : '0%';

                    const row = [
                        student.number || '',
                        studentId,
                        `${student.prefix}${student.firstName} ${student.lastName}`,
                        stats.present,
                        stats.late,
                        stats.sick,
                        stats.business,
                        stats.permission,
                        stats.absent,
                        attendanceRate,
                        ...dates.map(date => {
                            const attendance = allAttendance[date]?.[studentId];
                            return attendance ? statusConfig[attendance.status]?.symbol || '-' : '-';
                        })
                    ];
                    sheetsData.push(row);
                });

                updateProgress(90, 'กำลังสร้าง CSV...');

                // Convert to CSV format
                const csvContent = sheetsData.map(row => 
                    row.map(cell => {
                        // Escape quotes and wrap in quotes if contains comma, quote, or newline
                        const cellStr = String(cell || '');
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    }).join(',')
                ).join('\n');

                // Add BOM for proper UTF-8 encoding in Excel
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;

                updateProgress(95, 'กำลังสร้างลิงก์...');

                // Create Google Sheets URL
                const encodedData = encodeURIComponent(csvWithBOM);
                const now = new Date();
                const safeClassName = className.replace(/[/\\?%*:|"<>]/g, '-').substring(0, 30);
                const filename = `สรุปผลการเรียน_${safeClassName}_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                
                // Create a data URL for the CSV
                const dataUrl = `data:text/csv;charset=utf-8,${encodedData}`;
                
                updateProgress(100, 'เสร็จสิ้น!');

                // Show success message with options
                const result = await Swal.fire({
                    icon: 'success',
                    html: `
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                                <i class="fab fa-google text-3xl text-green-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-green-600 mb-2">ข้อมูลพร้อม Export!</h3>
                            <div class="bg-green-50 rounded-lg p-4 mb-4">
                                <p class="text-green-800 font-semibold">📊 ${filename}</p>
                                <p class="text-green-600 text-sm mt-1">เลือกวิธีการ Export ที่ต้องการ</p>
                            </div>
                            
                            <div class="space-y-3 mb-4">
                                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                    <div class="flex items-center mb-2">
                                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fab fa-google text-white text-sm"></i>
                                        </div>
                                        <h4 class="font-semibold text-blue-800">Google Sheets (แนะนำ)</h4>
                                    </div>
                                    <p class="text-blue-700 text-sm">นำเข้าข้อมูลไปยัง Google Sheets โดยตรง</p>
                                </div>
                                
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <div class="flex items-center mb-2">
                                        <div class="w-8 h-8 bg-gray-500 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-download text-white text-sm"></i>
                                        </div>
                                        <h4 class="font-semibold text-gray-800">ดาวน์โหลด CSV</h4>
                                    </div>
                                    <p class="text-gray-700 text-sm">ดาวน์โหลดไฟล์ CSV เพื่อนำเข้าเอง</p>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <div class="text-sm text-yellow-700 space-y-1">
                                    <p><strong>📋 ข้อมูลที่จะ Export:</strong></p>
                                    <p>• รายชื่อนักเรียน ${Object.keys(currentStudents).length} คน</p>
                                    <p>• ข้อมูลการเช็คชื่อ ${dates.length} วัน</p>
                                    <p>• สถิติการเข้าเรียนแต่ละคน</p>
                                    <p>• สัญลักษณ์การเข้าเรียนทุกวัน</p>
                                </div>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: '<i class="fab fa-google mr-2"></i>เปิด Google Sheets',
                    denyButtonText: '<i class="fas fa-download mr-2"></i>ดาวน์โหลด CSV',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#4285f4',
                    denyButtonColor: '#34d399',
                    cancelButtonColor: '#6b7280',
                    width: '600px',
                    customClass: {
                        confirmButton: 'rounded-xl px-6 py-3 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200',
                        denyButton: 'rounded-xl px-6 py-3 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200',
                        cancelButton: 'rounded-xl px-6 py-3 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200'
                    }
                });

                if (result.isConfirmed) {
                    // Open Google Sheets with import option
                    const googleSheetsUrl = 'https://sheets.google.com/';
                    window.open(googleSheetsUrl, '_blank');
                    
                    // Download CSV for manual import
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = filename + '.csv';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Show instructions
                    setTimeout(() => {
                        Swal.fire({
                            icon: 'info',
                            title: 'วิธีการนำเข้าข้อมูล',
                            html: `
                                <div class="text-left space-y-4">
                                    <div class="bg-blue-50 rounded-lg p-4">
                                        <h4 class="font-semibold text-blue-800 mb-3">ขั้นตอนการนำเข้าข้อมูล:</h4>
                                        <ol class="text-sm text-blue-700 space-y-2 list-decimal list-inside">
                                            <li>ใน Google Sheets ให้คลิก <strong>File → Import</strong></li>
                                            <li>เลือกแท็บ <strong>Upload</strong></li>
                                            <li>คลิก <strong>Select a file from your device</strong></li>
                                            <li>เลือกไฟล์ CSV ที่ดาวน์โหลดมา</li>
                                            <li>เลือก <strong>Import location: Create new spreadsheet</strong></li>
                                            <li>คลิก <strong>Import data</strong></li>
                                        </ol>
                                    </div>
                                    
                                    <div class="bg-green-50 rounded-lg p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                            <span class="font-semibold text-green-800">เสร็จแล้ว!</span>
                                        </div>
                                        <p class="text-green-700 text-sm">ข้อมูลจะถูกนำเข้าไปยัง Google Sheets พร้อมใช้งาน</p>
                                    </div>
                                </div>
                            `,
                            confirmButtonText: 'เข้าใจแล้ว',
                            confirmButtonColor: '#4285f4',
                            width: '500px'
                        });
                    }, 1000);
                    
                } else if (result.isDenied) {
                    // Download CSV only
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = filename + '.csv';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'ดาวน์โหลดสำเร็จ!',
                        html: `
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                                    <i class="fas fa-download text-2xl text-green-600"></i>
                                </div>
                                <p class="text-gray-600 mb-4">ไฟล์ CSV ถูกดาวน์โหลดแล้ว</p>
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <p class="text-blue-700 text-sm">💡 คุณสามารถนำไฟล์นี้ไปใช้กับ Google Sheets, Excel หรือโปรแกรมอื่นๆ ได้</p>
                                </div>
                            </div>
                        `,
                        confirmButtonText: 'เยี่ยมเลย!',
                        confirmButtonColor: '#10b981',
                        timer: 3000
                    });
                }

            } catch (error) {
                console.error('Export Google Sheets error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด!',
                    html: `
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                                <i class="fas fa-exclamation-circle text-2xl text-red-600"></i>
                            </div>
                            <p class="text-gray-600 mb-4">ไม่สามารถ Export Google Sheets ได้</p>
                            <div class="bg-red-50 rounded-lg p-4 mb-4">
                                <p class="text-red-700 text-sm">${error.message}</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-blue-700 text-sm">💡 กรุณาลองใหม่อีกครั้ง หรือติดต่อผู้ดูแลระบบ</p>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        async function exportToPdf() {
            if (!currentCourseId) return;

            try {
                // Show loading with progress
                Swal.fire({
                    html: `
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                                <i class="fas fa-file-pdf text-2xl text-red-600 animate-pulse"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">กำลังสร้างไฟล์ PDF</h3>
                            <p class="text-gray-600 mb-4">กรุณารอสักครู่...</p>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="pdfProgress" class="bg-red-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="pdfStatus" class="text-sm text-gray-500 mt-2">เริ่มต้นการประมวลผล...</p>
                        </div>
                    `,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    width: '400px'
                });

                // Update progress
                const updateProgress = (percent, status) => {
                    const progressBar = document.getElementById('pdfProgress');
                    const statusText = document.getElementById('pdfStatus');
                    if (progressBar) progressBar.style.width = percent + '%';
                    if (statusText) statusText.textContent = status;
                };

                updateProgress(20, 'กำลังโหลดข้อมูลการเช็คชื่อ...');

                // Get attendance data
                const attendanceRef = ref(database, `attendance/${currentCourseId}`);
                const snapshot = await get(attendanceRef);
                
                if (!snapshot.exists()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'ไม่มีข้อมูล',
                        html: `
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 rounded-full mb-4">
                                    <i class="fas fa-exclamation-triangle text-2xl text-yellow-600"></i>
                                </div>
                                <p class="text-gray-600">ไม่มีข้อมูลการเช็คชื่อสำหรับการ Export PDF</p>
                                <div class="bg-blue-50 rounded-lg p-4 mt-4">
                                    <p class="text-sm text-blue-700">💡 กรุณาทำการเช็คชื่อก่อนแล้วจึงลอง Export อีกครั้ง</p>
                                </div>
                            </div>
                        `,
                        confirmButtonText: 'เข้าใจแล้ว',
                        confirmButtonColor: '#f59e0b'
                    });
                    return;
                }

                updateProgress(40, 'กำลังประมวลผลข้อมูล...');

                const allAttendance = snapshot.val();
                const dates = Object.keys(allAttendance).sort();
                const className = document.getElementById('summaryClassName').textContent || 'ห้องเรียน';

                updateProgress(60, 'กำลังสร้าง PDF...');

                // Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); // landscape orientation

                // Title section
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('สรุปผลการเรียน', 20, 25);
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.text(className, 20, 35);
                
                doc.setFontSize(10);
                doc.text(`วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                })}`, 20, 45);
                
                doc.text(`จำนวนนักเรียน: ${Object.keys(currentStudents).length} คน`, 20, 52);
                doc.text(`จำนวนวันที่มีข้อมูล: ${dates.length} วัน`, 20, 59);

                // Legend
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('สัญลักษณ์:', 20, 70);
                doc.setFont('helvetica', 'normal');
                doc.text('1=มาเรียน, ส=มาสาย, ป=ลาป่วย, ก=ลากิจ, ว=ขอเวลาเรียน, ข=ขาดเรียน, -=ไม่มีข้อมูล', 50, 70);

                updateProgress(80, 'กำลังสร้างตาราง...');

                // Prepare table data with statistics
                const tableData = [];
                const sortedStudents = Object.entries(currentStudents).sort(([,a], [,b]) => {
                    const numA = parseInt(a.number) || 999;
                    const numB = parseInt(b.number) || 999;
                    return numA - numB;
                });

                sortedStudents.forEach(([studentId, student]) => {
                    // Calculate statistics
                    const stats = {
                        present: 0,
                        late: 0,
                        sick: 0,
                        business: 0,
                        permission: 0,
                        absent: 0
                    };

                    dates.forEach(date => {
                        const attendance = allAttendance[date]?.[studentId];
                        if (attendance && stats.hasOwnProperty(attendance.status)) {
                            stats[attendance.status]++;
                        }
                    });

                    const totalDays = dates.length;
                    const attendanceDays = stats.present + stats.late;
                    const attendanceRate = totalDays > 0 ? ((attendanceDays / totalDays) * 100).toFixed(1) + '%' : '0%';

                    const row = [
                        student.number || '',
                        studentId,
                        `${student.prefix}${student.firstName} ${student.lastName}`,
                        attendanceRate,
                        ...dates.map(date => {
                            const attendance = allAttendance[date]?.[studentId];
                            return attendance ? statusConfig[attendance.status]?.symbol || '-' : '-';
                        })
                    ];
                    tableData.push(row);
                });

                // Table headers
                const tableHeaders = [
                    'ลำดับ',
                    'รหัสนักเรียน', 
                    'ชื่อ-สกุล',
                    'เข้าเรียน%',
                    ...dates.map(date => formatDateShort(date))
                ];

                // Calculate column widths dynamically
                const pageWidth = doc.internal.pageSize.getWidth();
                const margins = 40;
                const availableWidth = pageWidth - margins;
                const fixedColumnsWidth = 15 + 25 + 40 + 20; // ลำดับ + รหัส + ชื่อ + %
                const dateColumnWidth = dates.length > 0 ? Math.max((availableWidth - fixedColumnsWidth) / dates.length, 8) : 10;

                const columnStyles = {
                    0: { cellWidth: 15, halign: 'center' }, // ลำดับ
                    1: { cellWidth: 25, halign: 'center' }, // รหัสนักเรียน
                    2: { cellWidth: 40, halign: 'left' },   // ชื่อ-สกุล
                    3: { cellWidth: 20, halign: 'center' }  // เปอร์เซ็นต์
                };

                // Add date column styles
                for (let i = 4; i < tableHeaders.length; i++) {
                    columnStyles[i] = { cellWidth: dateColumnWidth, halign: 'center' };
                }

                updateProgress(95, 'กำลังจัดรูปแบบ...');

                // Add table
                doc.autoTable({
                    head: [tableHeaders],
                    body: tableData,
                    startY: 80,
                    styles: {
                        fontSize: 7,
                        cellPadding: 1,
                        font: 'helvetica',
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [68, 114, 196],
                        textColor: 255,
                        fontSize: 7,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    columnStyles: columnStyles,
                    margin: { left: 20, right: 20 },
                    tableWidth: 'auto',
                    showHead: 'everyPage',
                    theme: 'striped',
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    didDrawPage: function (data) {
                        // Add page number
                        doc.setFontSize(8);
                        doc.text(`หน้า ${data.pageNumber}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
                    }
                });

                updateProgress(100, 'กำลังดาวน์โหลด...');

                // Generate safe filename
                const now = new Date();
                const safeClassName = className.replace(/[/\\?%*:|"<>]/g, '-').substring(0, 30);
                const filename = `สรุปผลการเรียน_${safeClassName}_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.pdf`;
                
                // Download PDF
                doc.save(filename);

                // Show success message
                await Swal.fire({
                    icon: 'success',
                    html: `
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-red-100 rounded-full mb-4">
                                <i class="fas fa-check-circle text-3xl text-red-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-red-600 mb-2">Export PDF สำเร็จ!</h3>
                            <div class="bg-red-50 rounded-lg p-4 mb-4">
                                <p class="text-red-800 font-semibold">📄 ${filename}</p>
                                <p class="text-red-600 text-sm mt-1">ไฟล์ถูกดาวน์โหลดไปยังโฟลเดอร์ Downloads แล้ว</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="text-sm text-blue-700 space-y-1">
                                    <p><strong>📋 ข้อมูลที่ Export:</strong></p>
                                    <p>• รายชื่อนักเรียน ${Object.keys(currentStudents).length} คน</p>
                                    <p>• ข้อมูลการเช็คชื่อ ${dates.length} วัน</p>
                                    <p>• เปอร์เซ็นต์การเข้าเรียนแต่ละคน</p>
                                    <p>• รูปแบบ PDF พร้อมพิมพ์</p>
                                </div>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'เยี่ยมเลย!',
                    confirmButtonColor: '#ef4444',
                    width: '500px'
                });

            } catch (error) {
                console.error('Export PDF error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด!',
                    html: `
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                                <i class="fas fa-exclamation-circle text-2xl text-red-600"></i>
                            </div>
                            <p class="text-gray-600 mb-4">ไม่สามารถ Export PDF ได้</p>
                            <div class="bg-red-50 rounded-lg p-4 mb-4">
                                <p class="text-red-700 text-sm">${error.message}</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-blue-700 text-sm">💡 กรุณาลองใหม่อีกครั้ง หรือติดต่อผู้ดูแลระบบ</p>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        // Archive and Delete Course Functions
        async function archiveCourse(courseId, courseName) {
            const result = await Swal.fire({
                title: 'จัดเก็บห้องเรียน?',
                html: `
                    <div class="text-left space-y-4">
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-archive text-yellow-600 mr-2"></i>
                                <span class="font-semibold text-yellow-800">การจัดเก็บห้องเรียน</span>
                            </div>
                            <p class="text-sm text-yellow-700">ห้องเรียน: <strong>${courseName}</strong></p>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                <span class="font-semibold text-blue-800">ผลของการจัดเก็บ</span>
                            </div>
                            <ul class="text-sm text-blue-700 space-y-1 list-disc list-inside">
                                <li>ห้องเรียนจะไม่แสดงในรายการหลัก</li>
                                <li>ข้อมูลทั้งหมดจะยังคงอยู่</li>
                                <li>สามารถกู้คืนได้ตลอดเวลา</li>
                                <li>ไม่สามารถเข้าใช้งานได้จนกว่าจะกู้คืน</li>
                            </ul>
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'จัดเก็บ',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#f59e0b',
                cancelButtonColor: '#6b7280',
                width: '500px'
            });

            if (result.isConfirmed) {
                try {
                    // Update course to archived
                    const courseRef = ref(database, `courses/${courseId}/archived`);
                    await set(courseRef, true);
                    
                    // Add archived timestamp
                    const archivedAtRef = ref(database, `courses/${courseId}/archivedAt`);
                    await set(archivedAtRef, new Date().toISOString());

                    // Refresh class list
                    await loadClasses();

                    Swal.fire({
                        icon: 'success',
                        title: 'จัดเก็บสำเร็จ!',
                        text: `ห้องเรียน "${courseName}" ถูกจัดเก็บแล้ว`,
                        timer: 2000,
                        showConfirmButton: false
                    });

                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด!',
                        text: 'ไม่สามารถจัดเก็บห้องเรียนได้: ' + error.message
                    });
                }
            }
        }

        async function deleteCourse(courseId, courseName) {
            const result = await Swal.fire({
                title: 'ลบห้องเรียน?',
                html: `
                    <div class="text-left space-y-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                <span class="font-semibold text-red-800">คำเตือน: การลบไม่สามารถย้อนกลับได้!</span>
                            </div>
                            <p class="text-sm text-red-700">ห้องเรียน: <strong>${courseName}</strong></p>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-trash text-gray-600 mr-2"></i>
                                <span class="font-semibold text-gray-800">ข้อมูลที่จะถูกลบ</span>
                            </div>
                            <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
                                <li>ข้อมูลห้องเรียนทั้งหมด</li>
                                <li>รายชื่อนักเรียนในห้องเรียน</li>
                                <li>ประวัติการเช็คชื่อทั้งหมด</li>
                                <li>ข้อมูลสถิติการเรียน</li>
                            </ul>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>
                                <span class="font-semibold text-yellow-800">แนะนำ</span>
                            </div>
                            <p class="text-sm text-yellow-700">หากต้องการเก็บข้อมูลไว้ ให้เลือก "จัดเก็บห้องเรียน" แทน</p>
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบถาวร',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                width: '600px',
                input: 'text',
                inputPlaceholder: `พิมพ์ "${courseName}" เพื่อยืนยัน`,
                inputValidator: (value) => {
                    if (value !== courseName) {
                        return 'กรุณาพิมพ์ชื่อห้องเรียนให้ถูกต้อง';
                    }
                }
            });

            if (result.isConfirmed) {
                try {
                    // Show loading
                    Swal.fire({
                        title: 'กำลังลบข้อมูล...',
                        text: 'กรุณารอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Delete all related data
                    const deletePromises = [
                        // Delete course
                        set(ref(database, `courses/${courseId}`), null),
                        // Delete students
                        set(ref(database, `students/${courseId}`), null),
                        // Delete attendance
                        set(ref(database, `attendance/${courseId}`), null)
                    ];

                    await Promise.all(deletePromises);

                    // Refresh class list
                    await loadClasses();

                    Swal.fire({
                        icon: 'success',
                        title: 'ลบสำเร็จ!',
                        text: `ห้องเรียน "${courseName}" ถูกลบออกจากระบบแล้ว`,
                        timer: 3000,
                        showConfirmButton: false
                    });

                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด!',
                        text: 'ไม่สามารถลบห้องเรียนได้: ' + error.message
                    });
                }
            }
        }

        async function showArchivedClasses() {
            const modal = document.getElementById('archivedClassesModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Load archived classes
            const coursesRef = ref(database, 'courses');
            const snapshot = await get(coursesRef);
            const archivedList = document.getElementById('archivedClassesList');
            const noArchivedDiv = document.getElementById('noArchivedClasses');
            
            archivedList.innerHTML = '';

            if (snapshot.exists()) {
                const courses = snapshot.val();
                const archivedCourses = Object.entries(courses).filter(([id, course]) => 
                    course.teacherId === currentUser.uid && course.archived
                );

                if (archivedCourses.length > 0) {
                    noArchivedDiv.style.display = 'none';
                    
                    archivedCourses.forEach(([courseId, course], index) => {
                        const gradientClass = `gradient-bg-${(index % 6) + 1}`;
                        const card = document.createElement('div');
                        card.className = `${gradientClass} rounded-lg shadow-md text-white p-6 relative opacity-75`;
                        card.innerHTML = `
                            <div class="flex items-center justify-between mb-4">
                                <i class="fas fa-archive text-2xl opacity-80"></i>
                                <span class="text-sm opacity-80">${course.code}</span>
                            </div>
                            <h3 class="text-xl font-bold mb-2">${course.name}</h3>
                            <p class="text-sm opacity-90 mb-4">จัดเก็บเมื่อ: ${course.archivedAt ? formatDate(course.archivedAt.split('T')[0]) : 'ไม่ทราบ'}</p>
                            
                            <div class="flex space-x-2">
                                <button class="restore-btn flex-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg py-2 px-3 text-sm font-medium transition-all duration-200"
                                        data-course-id="${courseId}" 
                                        data-course-name="${course.name}">
                                    <i class="fas fa-undo mr-2"></i>กู้คืน
                                </button>
                                <button class="delete-archived-btn bg-red-500 bg-opacity-80 hover:bg-opacity-100 rounded-lg py-2 px-3 text-sm font-medium transition-all duration-200"
                                        data-course-id="${courseId}" 
                                        data-course-name="${course.name}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        archivedList.appendChild(card);
                    });

                    // Add event listeners for archived course buttons
                    document.querySelectorAll('.restore-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const courseId = e.currentTarget.dataset.courseId;
                            const courseName = e.currentTarget.dataset.courseName;
                            restoreCourse(courseId, courseName);
                        });
                    });

                    document.querySelectorAll('.delete-archived-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const courseId = e.currentTarget.dataset.courseId;
                            const courseName = e.currentTarget.dataset.courseName;
                            deleteCourse(courseId, courseName);
                        });
                    });
                } else {
                    noArchivedDiv.style.display = 'block';
                }
            } else {
                noArchivedDiv.style.display = 'block';
            }
        }

        function closeArchivedClasses() {
            const modal = document.getElementById('archivedClassesModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function restoreCourse(courseId, courseName) {
            const result = await Swal.fire({
                title: 'กู้คืนห้องเรียน?',
                html: `
                    <div class="text-left space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-undo text-green-600 mr-2"></i>
                                <span class="font-semibold text-green-800">การกู้คืนห้องเรียน</span>
                            </div>
                            <p class="text-sm text-green-700">ห้องเรียน: <strong>${courseName}</strong></p>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                <span class="font-semibold text-blue-800">ผลของการกู้คืน</span>
                            </div>
                            <ul class="text-sm text-blue-700 space-y-1 list-disc list-inside">
                                <li>ห้องเรียนจะกลับมาแสดงในรายการหลัก</li>
                                <li>สามารถเข้าใช้งานได้ตามปกติ</li>
                                <li>ข้อมูลทั้งหมดจะยังคงอยู่</li>
                            </ul>
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'กู้คืน',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                width: '500px'
            });

            if (result.isConfirmed) {
                try {
                    // Remove archived flag
                    const courseRef = ref(database, `courses/${courseId}/archived`);
                    await set(courseRef, null);
                    
                    // Remove archived timestamp
                    const archivedAtRef = ref(database, `courses/${courseId}/archivedAt`);
                    await set(archivedAtRef, null);

                    // Refresh archived list
                    await showArchivedClasses();
                    
                    // Refresh main class list if it's visible
                    if (!document.getElementById('classListPage').classList.contains('hidden')) {
                        await loadClasses();
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'กู้คืนสำเร็จ!',
                        text: `ห้องเรียน "${courseName}" ถูกกู้คืนแล้ว`,
                        timer: 2000,
                        showConfirmButton: false
                    });

                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด!',
                        text: 'ไม่สามารถกู้คืนห้องเรียนได้: ' + error.message
                    });
                }
            }
        }

        // User Profile Functions
        function updateUserInfo(user) {
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userEmailDropdown').textContent = user.email;
            document.getElementById('userDisplayName').textContent = user.displayName || 'ผู้ใช้งาน';
        }

        function toggleUserDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('hidden');
        }

        function openEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            document.getElementById('editDisplayName').value = currentUser.displayName || '';
            document.getElementById('editEmail').value = currentUser.email;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('userDropdown').classList.add('hidden');
        }

        function closeEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('editProfileForm').reset();
        }

        function openChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('userDropdown').classList.add('hidden');
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('changePasswordForm').reset();
        }

        async function handleEditProfile(e) {
            e.preventDefault();
            const newDisplayName = document.getElementById('editDisplayName').value.trim();

            if (!newDisplayName) {
                alert('กรุณากรอกชื่อ-นามสกุล');
                return;
            }

            try {
                // Show loading
                Swal.fire({
                    title: 'กำลังอัปเดตข้อมูล...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Update Firebase Auth profile
                await updateProfile(currentUser, {
                    displayName: newDisplayName
                });

                // Update in database
                const teacherRef = ref(database, `teachers/${currentUser.uid}/fullName`);
                await set(teacherRef, newDisplayName);

                // Update UI
                updateUserInfo(currentUser);
                closeEditProfileModal();

                Swal.fire({
                    icon: 'success',
                    title: 'อัปเดตข้อมูลสำเร็จ!',
                    text: `ข้อมูลของ ${newDisplayName} ถูกอัปเดตแล้ว`,
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด!',
                    text: 'ไม่สามารถอัปเดตข้อมูลได้: ' + error.message
                });
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            // Validate passwords match
            if (newPassword !== confirmNewPassword) {
                alert('รหัสผ่านใหม่ไม่ตรงกัน กรุณาตรวจสอบอีกครั้ง');
                return;
            }

            // Validate password length
            if (newPassword.length < 6) {
                alert('รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }

            try {
                // Show loading
                Swal.fire({
                    title: 'กำลังเปลี่ยนรหัสผ่าน...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Import updatePassword function
                const { updatePassword } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js");
                
                // Verify current password by signing in
                await signInWithEmailAndPassword(auth, currentUser.email, currentPassword);
                
                // Update password
                await updatePassword(currentUser, newPassword);

                closeChangePasswordModal();

                Swal.fire({
                    icon: 'success',
                    title: 'เปลี่ยนรหัสผ่านสำเร็จ!',
                    text: 'รหัสผ่านของคุณถูกอัปเดตแล้ว',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                let errorMessage = 'ไม่สามารถเปลี่ยนรหัสผ่านได้';
                
                switch (error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'รหัสผ่านปัจจุบันไม่ถูกต้อง';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'รหัสผ่านใหม่ไม่ปลอดภัยเพียงพอ';
                        break;
                    case 'auth/requires-recent-login':
                        errorMessage = 'กรุณาเข้าสู่ระบบใหม่แล้วลองอีกครั้ง';
                        break;
                    default:
                        errorMessage += ': ' + error.message;
                }

                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด!',
                    text: errorMessage
                });
            }
        }

        // Make functions globally accessible
        window.editStudent = editStudent;
        window.toggleDeleteStudent = toggleDeleteStudent;
        window.archiveCourse = archiveCourse;
        window.deleteCourse = deleteCourse;
        window.restoreCourse = restoreCourse;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'975fa528540da1c8',t:'MTc1NjM0MDQ1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
